"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core = require("@aws-cdk/core");
const AWS = require("aws-sdk");
const fs = require("fs-extra");
const path = require("path");
const api_1 = require("../../../lib/api");
const bootstrap_environment2_1 = require("../../../lib/api/bootstrap/bootstrap-environment2");
const my_test_cdk_stack_1 = require("./example-cdk-app/my-test-cdk-stack");
jest.setTimeout(600000);
describe('Bootstrapping', () => {
    const bootstrapStackName = 'AwsCdkBootstrapIntegTestLegacy';
    const account = requireEnvVariable('TEST_ACCOUNT');
    const region = requireEnvVariable('TEST_REGION');
    let s3;
    let env;
    let sdk;
    beforeAll(() => {
        s3 = new AWS.S3();
        env = {
            name: 'aws-cdk-bootstrap-integ-test',
            account,
            region,
        };
        sdk = new api_1.SDK({
            userAgent: 'aws-cdk-bootstrap-integ-test',
        });
    });
    describe('deploys the legacy bootstrap stack', () => {
        const legacyBootstrapBucketName = 'aws-cdk-bootstrap-integ-test-legacy-bckt';
        const newBootstrapBucketName = 'aws-cdk-bootstrap-integ-test-v2-bckt';
        const exampleAppStack = 'BootstrapIntegTestExampleCdkAppStack';
        const outdir = path.join(__dirname, 'cdk.out');
        let bootstrapStack;
        let testStack;
        beforeAll(async () => {
            // bootstrap the "old" way
            const bootstrapResults = await api_1.bootstrapEnvironment(env, sdk, bootstrapStackName, undefined, {
                bucketName: legacyBootstrapBucketName,
            });
            bootstrapStack = bootstrapResults.stackArtifact;
        });
        test('and then can deploy a CDK app using that bootstrap stack', async () => {
            testStack = await deployCdkApp(outdir, env, sdk, bootstrapStackName, (app) => {
                new my_test_cdk_stack_1.MyTestCdkStack(app, exampleAppStack, {
                    assetType: my_test_cdk_stack_1.ExampleAsset.ASSET_1,
                });
            });
        });
        describe('and then updates the bootstrap stack with the new resources', () => {
            beforeAll(async () => {
                // bootstrap the "new" way
                const bootstrapResults = await bootstrap_environment2_1.bootstrapEnvironment2(env, sdk, bootstrapStackName, undefined, {
                    bucketName: newBootstrapBucketName,
                    trustedAccounts: ['790124522186', '593667001225'],
                    cloudFormationExecutionPolicies: [
                        'arn:aws:iam::aws:policy/AdministratorAccess',
                        'arn:aws:iam::aws:policy/AmazonS3FullAccess',
                    ],
                });
                bootstrapStack = bootstrapResults.stackArtifact;
            });
            test('can now update the CDK app with the new bootstrap stack', async () => {
                await deployCdkApp(outdir, env, sdk, bootstrapStackName, (app) => {
                    new my_test_cdk_stack_1.MyTestCdkStack(app, exampleAppStack, {
                        assetType: my_test_cdk_stack_1.ExampleAsset.ASSET_2,
                    });
                });
            });
            afterAll(async () => {
                // empty and delete the now orphaned previous bootstrap bucket
                await emptyBucket(s3, legacyBootstrapBucketName);
                return s3.deleteBucket({ Bucket: legacyBootstrapBucketName }).promise();
            });
        });
        afterAll(() => {
            // delete the test CDK app stack
            return api_1.destroyStack({
                stack: testStack,
                sdk,
            });
        });
        afterAll(async () => {
            // empty the bootstrap bucket -
            // otherwise, CloudFormation will fail to delete the bootstrap stack
            await emptyBucket(s3, newBootstrapBucketName);
            return api_1.destroyStack({
                stack: bootstrapStack,
                sdk,
            });
        });
    });
});
function requireEnvVariable(variableName) {
    const ret = process.env[variableName];
    if (!ret) {
        throw new Error(`It is mandatory to set the '${variableName}' environment variable before running this test`);
    }
    return ret;
}
async function deployCdkApp(outdir, env, sdk, bootstrapStackName, cdkCode) {
    // clean the output directory, just to make 100% sure there is no junk left there
    await fs.remove(outdir);
    // synthesize an app to a local cdk.out
    const app = new core.App({ outdir });
    cdkCode(app);
    const assembly = app.synth();
    // now deploy the synthesized app
    const toolkitInfo = await api_1.loadToolkitInfo(env, sdk, bootstrapStackName);
    const testStack = assembly.stacks[0]; // we assume there's just one stack
    await api_1.deployStack({
        stack: testStack,
        toolkitInfo,
        sdk,
    });
    return testStack;
}
async function emptyBucket(s3, bucketName) {
    const objects = await s3.listObjects({ Bucket: bucketName }).promise();
    const deletes = (objects.Contents || []).map(obj => obj.Key || '').filter(d => !!d);
    if (deletes.length === 0) {
        return Promise.resolve();
    }
    return s3.deleteObjects({
        Bucket: bucketName,
        Delete: {
            Objects: deletes.map(d => ({ Key: d })),
            Quiet: false,
        },
    }).promise();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLmludGVnLXRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJib290c3RyYXAuaW50ZWctdGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUFzQztBQUV0QywrQkFBK0I7QUFDL0IsK0JBQStCO0FBQy9CLDZCQUE2QjtBQUM3QiwwQ0FBK0c7QUFDL0csOEZBQTBGO0FBQzFGLDJFQUFtRjtBQUVuRixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU8sQ0FBQyxDQUFDO0FBRXpCLFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO0lBQzdCLE1BQU0sa0JBQWtCLEdBQUcsZ0NBQWdDLENBQUM7SUFFNUQsTUFBTSxPQUFPLEdBQUcsa0JBQWtCLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDbkQsTUFBTSxNQUFNLEdBQUcsa0JBQWtCLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDakQsSUFBSSxFQUFVLENBQUM7SUFDZixJQUFJLEdBQXNCLENBQUM7SUFDM0IsSUFBSSxHQUFTLENBQUM7SUFFZCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsRUFBRSxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2xCLEdBQUcsR0FBRztZQUNKLElBQUksRUFBRSw4QkFBOEI7WUFDcEMsT0FBTztZQUNQLE1BQU07U0FDUCxDQUFDO1FBQ0YsR0FBRyxHQUFHLElBQUksU0FBRyxDQUFDO1lBQ1osU0FBUyxFQUFFLDhCQUE4QjtTQUMxQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7UUFDbEQsTUFBTSx5QkFBeUIsR0FBRywwQ0FBMEMsQ0FBQztRQUM3RSxNQUFNLHNCQUFzQixHQUFHLHNDQUFzQyxDQUFDO1FBQ3RFLE1BQU0sZUFBZSxHQUFHLHNDQUFzQyxDQUFDO1FBQy9ELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxF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QUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDeEIsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7S0FDMUI7SUFDRCxPQUFPLEVBQUUsQ0FBQyxhQUFhLENBQUM7UUFDdEIsTUFBTSxFQUFFLFVBQVU7UUFDbEIsTUFBTSxFQUFFO1lBQ04sT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkMsS0FBSyxFQUFFLEtBQUs7U0FDYjtLQUNGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjb3JlIGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0ICogYXMgY3hhcGkgZnJvbSAnQGF3cy1jZGsvY3gtYXBpJztcbmltcG9ydCAqIGFzIEFXUyBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBib290c3RyYXBFbnZpcm9ubWVudCwgZGVwbG95U3RhY2ssIGRlc3Ryb3lTdGFjaywgSVNESywgbG9hZFRvb2xraXRJbmZvLCBTREsgfSBmcm9tICcuLi8uLi8uLi9saWIvYXBpJztcbmltcG9ydCB7IGJvb3RzdHJhcEVudmlyb25tZW50MiB9IGZyb20gJy4uLy4uLy4uL2xpYi9hcGkvYm9vdHN0cmFwL2Jvb3RzdHJhcC1lbnZpcm9ubWVudDInO1xuaW1wb3J0IHsgRXhhbXBsZUFzc2V0LCBNeVRlc3RDZGtTdGFjayB9IGZyb20gJy4vZXhhbXBsZS1jZGstYXBwL215LXRlc3QtY2RrLXN0YWNrJztcblxuamVzdC5zZXRUaW1lb3V0KDYwMF8wMDApO1xuXG5kZXNjcmliZSgnQm9vdHN0cmFwcGluZycsICgpID0+IHtcbiAgY29uc3QgYm9vdHN0cmFwU3RhY2tOYW1lID0gJ0F3c0Nka0Jvb3RzdHJhcEludGVnVGVzdExlZ2FjeSc7XG5cbiAgY29uc3QgYWNjb3VudCA9IHJlcXVpcmVFbnZWYXJpYWJsZSgnVEVTVF9BQ0NPVU5UJyk7XG4gIGNvbnN0IHJlZ2lvbiA9IHJlcXVpcmVFbnZWYXJpYWJsZSgnVEVTVF9SRUdJT04nKTtcbiAgbGV0IHMzOiBBV1MuUzM7XG4gIGxldCBlbnY6IGN4YXBpLkVudmlyb25tZW50O1xuICBsZXQgc2RrOiBJU0RLO1xuXG4gIGJlZm9yZUFsbCgoKSA9PiB7XG4gICAgczMgPSBuZXcgQVdTLlMzKCk7XG4gICAgZW52ID0ge1xuICAgICAgbmFtZTogJ2F3cy1jZGstYm9vdHN0cmFwLWludGVnLXRlc3QnLFxuICAgICAgYWNjb3VudCxcbiAgICAgIHJlZ2lvbixcbiAgICB9O1xuICAgIHNkayA9IG5ldyBTREsoe1xuICAgICAgdXNlckFnZW50OiAnYXdzLWNkay1ib290c3RyYXAtaW50ZWctdGVzdCcsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdkZXBsb3lzIHRoZSBsZWdhY3kgYm9vdHN0cmFwIHN0YWNrJywgKCkgPT4ge1xuICAgIGNvbnN0IGxlZ2FjeUJvb3RzdHJhcEJ1Y2tldE5hbWUgPSAnYXdzLWNkay1ib290c3RyYXAtaW50ZWctdGVzdC1sZWdhY3ktYmNrdCc7XG4gICAgY29uc3QgbmV3Qm9vdHN0cmFwQnVja2V0TmFtZSA9ICdhd3MtY2RrLWJvb3RzdHJhcC1pbnRlZy10ZXN0LXYyLWJja3QnO1xuICAgIGNvbnN0IGV4YW1wbGVBcHBTdGFjayA9ICdCb290c3RyYXBJbnRlZ1Rlc3RFeGFtcGxlQ2RrQXBwU3RhY2snO1xuICAgIGNvbnN0IG91dGRpciA9IHBhdGguam9pbihfX2Rpcm5hbWUsICdjZGsub3V0Jyk7XG5cbiAgICBsZXQgYm9vdHN0cmFwU3RhY2s6IGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdDtcbiAgICBsZXQgdGVzdFN0YWNrOiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3Q7XG5cbiAgICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gYm9vdHN0cmFwIHRoZSBcIm9sZFwiIHdheVxuICAgICAgY29uc3QgYm9vdHN0cmFwUmVzdWx0cyA9IGF3YWl0IGJvb3RzdHJhcEVudmlyb25tZW50KGVudiwgc2RrLCBib290c3RyYXBTdGFja05hbWUsIHVuZGVmaW5lZCwge1xuICAgICAgICBidWNrZXROYW1lOiBsZWdhY3lCb290c3RyYXBCdWNrZXROYW1lLFxuICAgICAgfSk7XG4gICAgICBib290c3RyYXBTdGFjayA9IGJvb3RzdHJhcFJlc3VsdHMuc3RhY2tBcnRpZmFjdDtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2FuZCB0aGVuIGNhbiBkZXBsb3kgYSBDREsgYXBwIHVzaW5nIHRoYXQgYm9vdHN0cmFwIHN0YWNrJywgYXN5bmMgKCkgPT4ge1xuICAgICAgdGVzdFN0YWNrID0gYXdhaXQgZGVwbG95Q2RrQXBwKG91dGRpciwgZW52LCBzZGssIGJvb3RzdHJhcFN0YWNrTmFtZSwgKGFwcCkgPT4ge1xuICAgICAgICBuZXcgTXlUZXN0Q2RrU3RhY2soYXBwLCBleGFtcGxlQXBwU3RhY2ssIHtcbiAgICAgICAgICBhc3NldFR5cGU6IEV4YW1wbGVBc3NldC5BU1NFVF8xLFxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2FuZCB0aGVuIHVwZGF0ZXMgdGhlIGJvb3RzdHJhcCBzdGFjayB3aXRoIHRoZSBuZXcgcmVzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAgICAgLy8gYm9vdHN0cmFwIHRoZSBcIm5ld1wiIHdheVxuICAgICAgICBjb25zdCBib290c3RyYXBSZXN1bHRzID0gYXdhaXQgYm9vdHN0cmFwRW52aXJvbm1lbnQyKGVudiwgc2RrLCBib290c3RyYXBTdGFja05hbWUsIHVuZGVmaW5lZCwge1xuICAgICAgICAgIGJ1Y2tldE5hbWU6IG5ld0Jvb3RzdHJhcEJ1Y2tldE5hbWUsXG4gICAgICAgICAgdHJ1c3RlZEFjY291bnRzOiBbJzc5MDEyNDUyMjE4NicsICc1OTM2NjcwMDEyMjUnXSxcbiAgICAgICAgICBjbG91ZEZvcm1hdGlvbkV4ZWN1dGlvblBvbGljaWVzOiBbXG4gICAgICAgICAgICAnYXJuOmF3czppYW06OmF3czpwb2xpY3kvQWRtaW5pc3RyYXRvckFjY2VzcycsXG4gICAgICAgICAgICAnYXJuOmF3czppYW06OmF3czpwb2xpY3kvQW1hem9uUzNGdWxsQWNjZXNzJyxcbiAgICAgICAgICBdLFxuICAgICAgICB9KTtcbiAgICAgICAgYm9vdHN0cmFwU3RhY2sgPSBib290c3RyYXBSZXN1bHRzLnN0YWNrQXJ0aWZhY3Q7XG4gICAgICB9KTtcblxuICAgICAgdGVzdCgnY2FuIG5vdyB1cGRhdGUgdGhlIENESyBhcHAgd2l0aCB0aGUgbmV3IGJvb3RzdHJhcCBzdGFjaycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgZGVwbG95Q2RrQXBwKG91dGRpciwgZW52LCBzZGssIGJvb3RzdHJhcFN0YWNrTmFtZSwgKGFwcCkgPT4ge1xuICAgICAgICAgIG5ldyBNeVRlc3RDZGtTdGFjayhhcHAsIGV4YW1wbGVBcHBTdGFjaywge1xuICAgICAgICAgICAgYXNzZXRUeXBlOiBFeGFtcGxlQXNzZXQuQVNTRVRfMixcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgICAgICAvLyBlbXB0eSBhbmQgZGVsZXRlIHRoZSBub3cgb3JwaGFuZWQgcHJldmlvdXMgYm9vdHN0cmFwIGJ1Y2tldFxuICAgICAgICBhd2FpdCBlbXB0eUJ1Y2tldChzMywgbGVnYWN5Qm9vdHN0cmFwQnVja2V0TmFtZSk7XG4gICAgICAgIHJldHVybiBzMy5kZWxldGVCdWNrZXQoeyBCdWNrZXQ6IGxlZ2FjeUJvb3RzdHJhcEJ1Y2tldE5hbWUgfSkucHJvbWlzZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBhZnRlckFsbCgoKSA9PiB7XG4gICAgICAvLyBkZWxldGUgdGhlIHRlc3QgQ0RLIGFwcCBzdGFja1xuICAgICAgcmV0dXJuIGRlc3Ryb3lTdGFjayh7XG4gICAgICAgIHN0YWNrOiB0ZXN0U3RhY2ssXG4gICAgICAgIHNkayxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gZW1wdHkgdGhlIGJvb3RzdHJhcCBidWNrZXQgLVxuICAgICAgLy8gb3RoZXJ3aXNlLCBDbG91ZEZvcm1hdGlvbiB3aWxsIGZhaWwgdG8gZGVsZXRlIHRoZSBib290c3RyYXAgc3RhY2tcbiAgICAgIGF3YWl0IGVtcHR5QnVja2V0KHMzLCBuZXdCb290c3RyYXBCdWNrZXROYW1lKTtcblxuICAgICAgcmV0dXJuIGRlc3Ryb3lTdGFjayh7XG4gICAgICAgIHN0YWNrOiBib290c3RyYXBTdGFjayxcbiAgICAgICAgc2RrLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbmZ1bmN0aW9uIHJlcXVpcmVFbnZWYXJpYWJsZSh2YXJpYWJsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IHJldCA9IHByb2Nlc3MuZW52W3ZhcmlhYmxlTmFtZV07XG4gIGlmICghcmV0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJdCBpcyBtYW5kYXRvcnkgdG8gc2V0IHRoZSAnJHt2YXJpYWJsZU5hbWV9JyBlbnZpcm9ubWVudCB2YXJpYWJsZSBiZWZvcmUgcnVubmluZyB0aGlzIHRlc3RgKTtcbiAgfVxuICByZXR1cm4gcmV0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZXBsb3lDZGtBcHAob3V0ZGlyOiBzdHJpbmcsIGVudjogY3hhcGkuRW52aXJvbm1lbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2RrOiBJU0RLLCBib290c3RyYXBTdGFja05hbWU6IHN0cmluZywgY2RrQ29kZTogKGFwcDogY29yZS5BcHApID0+IHZvaWQpIHtcbiAgLy8gY2xlYW4gdGhlIG91dHB1dCBkaXJlY3RvcnksIGp1c3QgdG8gbWFrZSAxMDAlIHN1cmUgdGhlcmUgaXMgbm8ganVuayBsZWZ0IHRoZXJlXG4gIGF3YWl0IGZzLnJlbW92ZShvdXRkaXIpO1xuXG4gIC8vIHN5bnRoZXNpemUgYW4gYXBwIHRvIGEgbG9jYWwgY2RrLm91dFxuICBjb25zdCBhcHAgPSBuZXcgY29yZS5BcHAoeyBvdXRkaXIgfSk7XG4gIGNka0NvZGUoYXBwKTtcbiAgY29uc3QgYXNzZW1ibHkgPSBhcHAuc3ludGgoKTtcblxuICAvLyBub3cgZGVwbG95IHRoZSBzeW50aGVzaXplZCBhcHBcbiAgY29uc3QgdG9vbGtpdEluZm8gPSBhd2FpdCBsb2FkVG9vbGtpdEluZm8oZW52LCBzZGssIGJvb3RzdHJhcFN0YWNrTmFtZSk7XG4gIGNvbnN0IHRlc3RTdGFjayA9IGFzc2VtYmx5LnN0YWNrc1swXTsgLy8gd2UgYXNzdW1lIHRoZXJlJ3MganVzdCBvbmUgc3RhY2tcbiAgYXdhaXQgZGVwbG95U3RhY2soe1xuICAgIHN0YWNrOiB0ZXN0U3RhY2ssXG4gICAgdG9vbGtpdEluZm8sXG4gICAgc2RrLFxuICB9KTtcbiAgcmV0dXJuIHRlc3RTdGFjaztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZW1wdHlCdWNrZXQoczM6IEFXUy5TMywgYnVja2V0TmFtZTogc3RyaW5nKSB7XG4gIGNvbnN0IG9iamVjdHMgPSBhd2FpdCBzMy5saXN0T2JqZWN0cyh7IEJ1Y2tldDogYnVja2V0TmFtZSB9KS5wcm9taXNlKCk7XG4gIGNvbnN0IGRlbGV0ZXMgPSAob2JqZWN0cy5Db250ZW50cyB8fCBbXSkubWFwKG9iaiA9PiBvYmouS2V5IHx8ICcnKS5maWx0ZXIoZCA9PiAhIWQpO1xuICBpZiAoZGVsZXRlcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cbiAgcmV0dXJuIHMzLmRlbGV0ZU9iamVjdHMoe1xuICAgIEJ1Y2tldDogYnVja2V0TmFtZSxcbiAgICBEZWxldGU6IHtcbiAgICAgIE9iamVjdHM6IGRlbGV0ZXMubWFwKGQgPT4gKHsgS2V5OiBkIH0pKSxcbiAgICAgIFF1aWV0OiBmYWxzZSxcbiAgICB9LFxuICB9KS5wcm9taXNlKCk7XG59XG4iXX0=