"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lib_1 = require("../../lib");
const serialize_1 = require("../../lib/serialize");
const mock_sdk_1 = require("../util/mock-sdk");
const env = {
    account: '123456789012',
    region: 'us-east-1',
    name: 'mock',
};
test('do bootstrap', async () => {
    // GIVEN
    const sdk = new mock_sdk_1.MockSDK();
    let executed = false;
    sdk.stubCloudFormation({
        describeStacks() {
            return {
                Stacks: []
            };
        },
        createChangeSet(info) {
            const template = serialize_1.fromYAML(info.TemplateBody);
            const bucketProperties = template.Resources.StagingBucket.Properties;
            expect(bucketProperties.BucketName).toBeUndefined();
            expect(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID)
                .toBeUndefined();
            return {};
        },
        describeChangeSet() {
            return {
                Status: 'CREATE_COMPLETE',
                Changes: [],
            };
        },
        executeChangeSet() {
            executed = true;
            return {};
        }
    });
    // WHEN
    const ret = await lib_1.bootstrapEnvironment(env, sdk, 'mockStack', undefined);
    // THEN
    expect(ret.noOp).toBeFalsy();
    expect(executed).toBeTruthy();
});
test('do bootstrap using custom bucket name', async () => {
    // GIVEN
    const sdk = new mock_sdk_1.MockSDK();
    let executed = false;
    sdk.stubCloudFormation({
        describeStacks() {
            return {
                Stacks: []
            };
        },
        createChangeSet(info) {
            const template = serialize_1.fromYAML(info.TemplateBody);
            const bucketProperties = template.Resources.StagingBucket.Properties;
            expect(bucketProperties.BucketName).toBe('foobar');
            expect(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID)
                .toBeUndefined();
            return {};
        },
        describeChangeSet() {
            return {
                Status: 'CREATE_COMPLETE',
                Changes: [],
            };
        },
        executeChangeSet() {
            executed = true;
            return {};
        }
    });
    // WHEN
    const ret = await lib_1.bootstrapEnvironment(env, sdk, 'mockStack', undefined, {
        bucketName: 'foobar',
    });
    // THEN
    expect(ret.noOp).toBeFalsy();
    expect(executed).toBeTruthy();
});
test('do bootstrap using KMS CMK', async () => {
    // GIVEN
    const sdk = new mock_sdk_1.MockSDK();
    let executed = false;
    sdk.stubCloudFormation({
        describeStacks() {
            return {
                Stacks: []
            };
        },
        createChangeSet(info) {
            const template = serialize_1.fromYAML(info.TemplateBody);
            const bucketProperties = template.Resources.StagingBucket.Properties;
            expect(bucketProperties.BucketName).toBeUndefined();
            expect(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID)
                .toBe('myKmsKey');
            return {};
        },
        describeChangeSet() {
            return {
                Status: 'CREATE_COMPLETE',
                Changes: [],
            };
        },
        executeChangeSet() {
            executed = true;
            return {};
        }
    });
    // WHEN
    const ret = await lib_1.bootstrapEnvironment(env, sdk, 'mockStack', undefined, {
        kmsKeyId: 'myKmsKey',
    });
    // THEN
    expect(ret.noOp).toBeFalsy();
    expect(executed).toBeTruthy();
});
test('do bootstrap with custom tags for toolkit stack', async () => {
    // GIVEN
    const sdk = new mock_sdk_1.MockSDK();
    let executed = false;
    sdk.stubCloudFormation({
        describeStacks() {
            return {
                Stacks: []
            };
        },
        createChangeSet(info) {
            const template = serialize_1.fromYAML(info.TemplateBody);
            const bucketProperties = template.Resources.StagingBucket.Properties;
            expect(bucketProperties.BucketName).toBeUndefined();
            expect(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID)
                .toBeUndefined();
            return {};
        },
        describeChangeSet() {
            return {
                Status: 'CREATE_COMPLETE',
                Changes: [],
            };
        },
        executeChangeSet() {
            executed = true;
            return {};
        }
    });
    // WHEN
    const ret = await lib_1.bootstrapEnvironment(env, sdk, 'mockStack', undefined, {
        tags: [{ Key: 'Foo', Value: 'Bar' }]
    });
    // THEN
    expect(ret.noOp).toBeFalsy();
    expect(executed).toBeTruthy();
});
test('passing trusted accounts to the old bootstrapping results in an error', async () => {
    const sdk = new mock_sdk_1.MockSDK();
    await expect(lib_1.bootstrapEnvironment(env, sdk, 'mockStack', undefined, {
        trustedAccounts: ['0123456789012'],
    }))
        .rejects
        .toThrow('--trust can only be passed for the new bootstrap experience!');
});
test('passing CFN execution policies to the old bootstrapping results in an error', async () => {
    const sdk = new mock_sdk_1.MockSDK();
    await expect(lib_1.bootstrapEnvironment(env, sdk, 'mockStack', undefined, {
        cloudFormationExecutionPolicies: ['arn:aws:iam::aws:policy/AdministratorAccess'],
    }))
        .rejects
        .toThrow('--cloudformation-execution-policies can only be passed for the new bootstrap experience!');
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJib290c3RyYXAudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLG1DQUFpRDtBQUNqRCxtREFBK0M7QUFDL0MsK0NBQTJDO0FBRTNDLE1BQU0sR0FBRyxHQUFHO0lBQ1YsT0FBTyxFQUFFLGNBQWM7SUFDdkIsTUFBTSxFQUFFLFdBQVc7SUFDbkIsSUFBSSxFQUFFLE1BQU07Q0FDYixDQUFDO0FBRUYsSUFBSSxDQUFDLGNBQWMsRUFBRSxLQUFLLElBQUksRUFBRTtJQUM5QixRQUFRO0lBQ1IsTUFBTSxHQUFHLEdBQUcsSUFBSSxrQkFBTyxFQUFFLENBQUM7SUFFMUIsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFDO0lBRXJCLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQztRQUNyQixjQUFjO1lBQ1osT0FBTztnQkFDTCxNQUFNLEVBQUUsRUFBRTthQUNYLENBQUM7UUFDSixDQUFDO1FBRUQsZUFBZSxDQUFDLElBQTBCO1lBQ3hDLE1BQU0sUUFBUSxHQUFHLG9CQUFRLENBQUMsSUFBSSxDQUFDLFlBQXNCLENBQUMsQ0FBQztZQUN2RCxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQztZQUNyRSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDcEQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLGlDQUFpQyxDQUFDLENBQUMsQ0FBQyxDQUFDLDZCQUE2QixDQUFDLGNBQWMsQ0FBQztpQkFDeEgsYUFBYSxFQUFFLENBQUM7WUFDbkIsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO1FBRUQsaUJBQWlCO1lBQ2YsT0FBTztnQkFDTCxNQUFNLEVBQUUsaUJBQWlCO2dCQUN6QixPQUFPLEVBQUUsRUFBRTthQUNaLENBQUM7UUFDSixDQUFDO1FBRUQsZ0JBQWdCO1lB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RSxFQUFFLEtBQUssSUFBSSxFQUFFO0lBQzdGLE1BQU0sR0FBRyxHQUFHLElBQUksa0JBQU8sRUFBRSxDQUFDO0lBRTFCLE1BQU0sTUFBTSxDQUFDLDBCQUFvQixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRTtRQUNsRSwrQkFBK0IsRUFBRSxDQUFDLDZDQUE2QyxDQUFDO0tBQ2pGLENBQUMsQ0FBQztTQUNGLE9BQU87U0FDUCxPQUFPLENBQUMsMEZBQTBGLENBQUMsQ0FBQztBQUN2RyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENyZWF0ZUNoYW5nZVNldElucHV0IH0gZnJvbSAnYXdzLXNkay9jbGllbnRzL2Nsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7IGJvb3RzdHJhcEVudmlyb25tZW50IH0gZnJvbSAnLi4vLi4vbGliJztcbmltcG9ydCB7IGZyb21ZQU1MIH0gZnJvbSAnLi4vLi4vbGliL3NlcmlhbGl6ZSc7XG5pbXBvcnQgeyBNb2NrU0RLIH0gZnJvbSAnLi4vdXRpbC9tb2NrLXNkayc7XG5cbmNvbnN0IGVudiA9IHtcbiAgYWNjb3VudDogJzEyMzQ1Njc4OTAxMicsXG4gIHJlZ2lvbjogJ3VzLWVhc3QtMScsXG4gIG5hbWU6ICdtb2NrJyxcbn07XG5cbnRlc3QoJ2RvIGJvb3RzdHJhcCcsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc2RrID0gbmV3IE1vY2tTREsoKTtcblxuICBsZXQgZXhlY3V0ZWQgPSBmYWxzZTtcblxuICBzZGsuc3R1YkNsb3VkRm9ybWF0aW9uKHtcbiAgICBkZXNjcmliZVN0YWNrcygpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIFN0YWNrczogW11cbiAgICAgIH07XG4gICAgfSxcblxuICAgIGNyZWF0ZUNoYW5nZVNldChpbmZvOiBDcmVhdGVDaGFuZ2VTZXRJbnB1dCkge1xuICAgICAgY29uc3QgdGVtcGxhdGUgPSBmcm9tWUFNTChpbmZvLlRlbXBsYXRlQm9keSBhcyBzdHJpbmcpO1xuICAgICAgY29uc3QgYnVja2V0UHJvcGVydGllcyA9IHRlbXBsYXRlLlJlc291cmNlcy5TdGFnaW5nQnVja2V0LlByb3BlcnRpZXM7XG4gICAgICBleHBlY3QoYnVja2V0UHJvcGVydGllcy5CdWNrZXROYW1lKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICBleHBlY3QoYnVja2V0UHJvcGVydGllcy5CdWNrZXRFbmNyeXB0aW9uLlNlcnZlclNpZGVFbmNyeXB0aW9uQ29uZmlndXJhdGlvblswXS5TZXJ2ZXJTaWRlRW5jcnlwdGlvbkJ5RGVmYXVsdC5LTVNNYXN0ZXJLZXlJRClcbiAgICAgICAgLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9LFxuXG4gICAgZGVzY3JpYmVDaGFuZ2VTZXQoKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGF0dXM6ICdDUkVBVEVfQ09NUExFVEUnLFxuICAgICAgICBDaGFuZ2VzOiBbXSxcbiAgICAgIH07XG4gICAgfSxcblxuICAgIGV4ZWN1dGVDaGFuZ2VTZXQoKSB7XG4gICAgICBleGVjdXRlZCA9IHRydWU7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IHJldCA9IGF3YWl0IGJvb3RzdHJhcEVudmlyb25tZW50KGVudiwgc2RrLCAnbW9ja1N0YWNrJywgdW5kZWZpbmVkKTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChyZXQubm9PcCkudG9CZUZhbHN5KCk7XG4gIGV4cGVjdChleGVjdXRlZCkudG9CZVRydXRoeSgpO1xufSk7XG5cbnRlc3QoJ2RvIGJvb3RzdHJhcCB1c2luZyBjdXN0b20gYnVja2V0IG5hbWUnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHNkayA9IG5ldyBNb2NrU0RLKCk7XG5cbiAgbGV0IGV4ZWN1dGVkID0gZmFsc2U7XG5cbiAgc2RrLnN0dWJDbG91ZEZvcm1hdGlvbih7XG4gICAgZGVzY3JpYmVTdGFja3MoKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGFja3M6IFtdXG4gICAgICB9O1xuICAgIH0sXG5cbiAgICBjcmVhdGVDaGFuZ2VTZXQoaW5mbzogQ3JlYXRlQ2hhbmdlU2V0SW5wdXQpIHtcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gZnJvbVlBTUwoaW5mby5UZW1wbGF0ZUJvZHkgYXMgc3RyaW5nKTtcbiAgICAgIGNvbnN0IGJ1Y2tldFByb3BlcnRpZXMgPSB0ZW1wbGF0ZS5SZXNvdXJjZXMuU3RhZ2luZ0J1Y2tldC5Qcm9wZXJ0aWVzO1xuICAgICAgZXhwZWN0KGJ1Y2tldFByb3BlcnRpZXMuQnVja2V0TmFtZSkudG9CZSgnZm9vYmFyJyk7XG4gICAgICBleHBlY3QoYnVja2V0UHJvcGVydGllcy5CdWNrZXRFbmNyeXB0aW9uLlNlcnZlclNpZGVFbmNyeXB0aW9uQ29uZmlndXJhdGlvblswXS5TZXJ2ZXJTaWRlRW5jcnlwdGlvbkJ5RGVmYXVsdC5LTVNNYXN0ZXJLZXlJRClcbiAgICAgICAgLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9LFxuXG4gICAgZGVzY3JpYmVDaGFuZ2VTZXQoKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGF0dXM6ICdDUkVBVEVfQ09NUExFVEUnLFxuICAgICAgICBDaGFuZ2VzOiBbXSxcbiAgICAgIH07XG4gICAgfSxcblxuICAgIGV4ZWN1dGVDaGFuZ2VTZXQoKSB7XG4gICAgICBleGVjdXRlZCA9IHRydWU7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IHJldCA9IGF3YWl0IGJvb3RzdHJhcEVudmlyb25tZW50KGVudiwgc2RrLCAnbW9ja1N0YWNrJywgdW5kZWZpbmVkLCB7XG4gICAgYnVja2V0TmFtZTogJ2Zvb2JhcicsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHJldC5ub09wKS50b0JlRmFsc3koKTtcbiAgZXhwZWN0KGV4ZWN1dGVkKS50b0JlVHJ1dGh5KCk7XG59KTtcbnRlc3QoJ2RvIGJvb3RzdHJhcCB1c2luZyBLTVMgQ01LJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzZGsgPSBuZXcgTW9ja1NESygpO1xuXG4gIGxldCBleGVjdXRlZCA9IGZhbHNlO1xuXG4gIHNkay5zdHViQ2xvdWRGb3JtYXRpb24oe1xuICAgIGRlc2NyaWJlU3RhY2tzKCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgU3RhY2tzOiBbXVxuICAgICAgfTtcbiAgICB9LFxuXG4gICAgY3JlYXRlQ2hhbmdlU2V0KGluZm86IENyZWF0ZUNoYW5nZVNldElucHV0KSB7XG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IGZyb21ZQU1MKGluZm8uVGVtcGxhdGVCb2R5IGFzIHN0cmluZyk7XG4gICAgICBjb25zdCBidWNrZXRQcm9wZXJ0aWVzID0gdGVtcGxhdGUuUmVzb3VyY2VzLlN0YWdpbmdCdWNrZXQuUHJvcGVydGllcztcbiAgICAgIGV4cGVjdChidWNrZXRQcm9wZXJ0aWVzLkJ1Y2tldE5hbWUpLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIGV4cGVjdChidWNrZXRQcm9wZXJ0aWVzLkJ1Y2tldEVuY3J5cHRpb24uU2VydmVyU2lkZUVuY3J5cHRpb25Db25maWd1cmF0aW9uWzBdLlNlcnZlclNpZGVFbmNyeXB0aW9uQnlEZWZhdWx0LktNU01hc3RlcktleUlEKVxuICAgICAgICAudG9CZSgnbXlLbXNLZXknKTtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9LFxuXG4gICAgZGVzY3JpYmVDaGFuZ2VTZXQoKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdGF0dXM6ICdDUkVBVEVfQ09NUExFVEUnLFxuICAgICAgICBDaGFuZ2VzOiBbXSxcbiAgICAgIH07XG4gICAgfSxcblxuICAgIGV4ZWN1dGVDaGFuZ2VTZXQoKSB7XG4gICAgICBleGVjdXRlZCA9IHRydWU7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IHJldCA9IGF3YWl0IGJvb3RzdHJhcEVudmlyb25tZW50KGVudiwgc2RrLCAnbW9ja1N0YWNrJywgdW5kZWZpbmVkLCB7XG4gICAga21zS2V5SWQ6ICdteUttc0tleScsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHJldC5ub09wKS50b0JlRmFsc3koKTtcbiAgZXhwZWN0KGV4ZWN1dGVkKS50b0JlVHJ1dGh5KCk7XG59KTtcbnRlc3QoJ2RvIGJvb3RzdHJhcCB3aXRoIGN1c3RvbSB0YWdzIGZvciB0b29sa2l0IHN0YWNrJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzZGsgPSBuZXcgTW9ja1NESygpO1xuXG4gIGxldCBleGVjdXRlZCA9IGZhbHNlO1xuXG4gIHNkay5zdHViQ2xvdWRGb3JtYXRpb24oe1xuICAgIGRlc2NyaWJlU3RhY2tzKCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgU3RhY2tzOiBbXVxuICAgICAgfTtcbiAgICB9LFxuXG4gICAgY3JlYXRlQ2hhbmdlU2V0KGluZm86IENyZWF0ZUNoYW5nZVNldElucHV0KSB7XG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IGZyb21ZQU1MKGluZm8uVGVtcGxhdGVCb2R5IGFzIHN0cmluZyk7XG4gICAgICBjb25zdCBidWNrZXRQcm9wZXJ0aWVzID0gdGVtcGxhdGUuUmVzb3VyY2VzLlN0YWdpbmdCdWNrZXQuUHJvcGVydGllcztcbiAgICAgIGV4cGVjdChidWNrZXRQcm9wZXJ0aWVzLkJ1Y2tldE5hbWUpLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIGV4cGVjdChidWNrZXRQcm9wZXJ0aWVzLkJ1Y2tldEVuY3J5cHRpb24uU2VydmVyU2lkZUVuY3J5cHRpb25Db25maWd1cmF0aW9uWzBdLlNlcnZlclNpZGVFbmNyeXB0aW9uQnlEZWZhdWx0LktNU01hc3RlcktleUlEKVxuICAgICAgICAudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH0sXG5cbiAgICBkZXNjcmliZUNoYW5nZVNldCgpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIFN0YXR1czogJ0NSRUFURV9DT01QTEVURScsXG4gICAgICAgIENoYW5nZXM6IFtdLFxuICAgICAgfTtcbiAgICB9LFxuXG4gICAgZXhlY3V0ZUNoYW5nZVNldCgpIHtcbiAgICAgIGV4ZWN1dGVkID0gdHJ1ZTtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgcmV0ID0gYXdhaXQgYm9vdHN0cmFwRW52aXJvbm1lbnQoZW52LCBzZGssICdtb2NrU3RhY2snLCB1bmRlZmluZWQsIHtcbiAgICB0YWdzOiBbeyBLZXk6ICdGb28nLCBWYWx1ZTogJ0JhcicgfV1cbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocmV0Lm5vT3ApLnRvQmVGYWxzeSgpO1xuICBleHBlY3QoZXhlY3V0ZWQpLnRvQmVUcnV0aHkoKTtcbn0pO1xuXG50ZXN0KCdwYXNzaW5nIHRydXN0ZWQgYWNjb3VudHMgdG8gdGhlIG9sZCBib290c3RyYXBwaW5nIHJlc3VsdHMgaW4gYW4gZXJyb3InLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHNkayA9IG5ldyBNb2NrU0RLKCk7XG5cbiAgYXdhaXQgZXhwZWN0KGJvb3RzdHJhcEVudmlyb25tZW50KGVudiwgc2RrLCAnbW9ja1N0YWNrJywgdW5kZWZpbmVkLCB7XG4gICAgdHJ1c3RlZEFjY291bnRzOiBbJzAxMjM0NTY3ODkwMTInXSxcbiAgfSkpXG4gIC5yZWplY3RzXG4gIC50b1Rocm93KCctLXRydXN0IGNhbiBvbmx5IGJlIHBhc3NlZCBmb3IgdGhlIG5ldyBib290c3RyYXAgZXhwZXJpZW5jZSEnKTtcbn0pO1xuXG50ZXN0KCdwYXNzaW5nIENGTiBleGVjdXRpb24gcG9saWNpZXMgdG8gdGhlIG9sZCBib290c3RyYXBwaW5nIHJlc3VsdHMgaW4gYW4gZXJyb3InLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHNkayA9IG5ldyBNb2NrU0RLKCk7XG5cbiAgYXdhaXQgZXhwZWN0KGJvb3RzdHJhcEVudmlyb25tZW50KGVudiwgc2RrLCAnbW9ja1N0YWNrJywgdW5kZWZpbmVkLCB7XG4gICAgY2xvdWRGb3JtYXRpb25FeGVjdXRpb25Qb2xpY2llczogWydhcm46YXdzOmlhbTo6YXdzOnBvbGljeS9BZG1pbmlzdHJhdG9yQWNjZXNzJ10sXG4gIH0pKVxuICAucmVqZWN0c1xuICAudG9UaHJvdygnLS1jbG91ZGZvcm1hdGlvbi1leGVjdXRpb24tcG9saWNpZXMgY2FuIG9ubHkgYmUgcGFzc2VkIGZvciB0aGUgbmV3IGJvb3RzdHJhcCBleHBlcmllbmNlIScpO1xufSk7XG4iXX0=