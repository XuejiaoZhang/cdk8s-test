"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lambda = require("@aws-cdk/aws-lambda");
const core_1 = require("@aws-cdk/core");
const path = require("path");
const cr = require("../../lib");
const util = require("../../lib/provider-framework/util");
require("@aws-cdk/assert/jest");
test('minimal setup', () => {
    // GIVEN
    const stack = new core_1.Stack();
    // WHEN
    new cr.Provider(stack, 'MyProvider', {
        onEventHandler: new lambda.Function(stack, 'MyHandler', {
            code: lambda.Code.fromAsset(path.join(__dirname, './integration-test-fixtures/s3-file-handler')),
            handler: 'index.onEvent',
            runtime: lambda.Runtime.NODEJS_10_X
        }),
    });
    // THEN
    // framework "onEvent" handler
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: "framework.onEvent",
        Environment: { Variables: { USER_ON_EVENT_FUNCTION_ARN: { "Fn::GetAtt": ["MyHandler6B74D312", "Arn"] } } },
        Timeout: 900
    });
    // user "onEvent" handler
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: "index.onEvent",
    });
    // no framework "is complete" handler or state machine
    expect(stack).not.toHaveResource('AWS::StepFunctions::StateMachine');
    expect(stack).not.toHaveResource('AWS::Lambda::Function', {
        Handler: "framework.isComplete",
        Timeout: 900
    });
});
test('if isComplete is specified, the isComplete framework handler is also included', () => {
    // GIVEN
    const stack = new core_1.Stack();
    const handler = new lambda.Function(stack, 'MyHandler', {
        code: lambda.Code.fromAsset(path.join(__dirname, './integration-test-fixtures/s3-file-handler')),
        handler: 'index.onEvent',
        runtime: lambda.Runtime.NODEJS_10_X
    });
    // WHEN
    new cr.Provider(stack, 'MyProvider', {
        onEventHandler: handler,
        isCompleteHandler: handler
    });
    // THEN
    // framework "onEvent" handler
    const expectedEnv = {
        Variables: {
            USER_ON_EVENT_FUNCTION_ARN: { "Fn::GetAtt": ["MyHandler6B74D312", "Arn"] },
            USER_IS_COMPLETE_FUNCTION_ARN: { "Fn::GetAtt": ["MyHandler6B74D312", "Arn"] }
        }
    };
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: "framework.onEvent",
        Timeout: 900,
        Environment: {
            Variables: {
                ...expectedEnv.Variables,
                WAITER_STATE_MACHINE_ARN: { Ref: "MyProviderwaiterstatemachineC1FBB9F9" }
            }
        }
    });
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: "framework.isComplete",
        Timeout: 900,
        Environment: expectedEnv
    });
    expect(stack).toHaveResource('AWS::Lambda::Function', {
        Handler: 'framework.onTimeout',
        Timeout: 900,
        Environment: expectedEnv
    });
    expect(stack).toHaveResource('AWS::StepFunctions::StateMachine', {
        DefinitionString: {
            "Fn::Join": [
                "",
                [
                    "{\"StartAt\":\"framework-isComplete-task\",\"States\":{\"framework-isComplete-task\":{\"End\":true,\"Retry\":[{\"ErrorEquals\":[\"States.ALL\"],\"IntervalSeconds\":5,\"MaxAttempts\":360,\"BackoffRate\":1}],\"Catch\":[{\"ErrorEquals\":[\"States.ALL\"],\"Next\":\"framework-onTimeout-task\"}],\"Type\":\"Task\",\"Resource\":\"",
                    {
                        "Fn::GetAtt": [
                            "MyProviderframeworkisComplete364190E2",
                            "Arn"
                        ]
                    },
                    "\"},\"framework-onTimeout-task\":{\"End\":true,\"Type\":\"Task\",\"Resource\":\"",
                    {
                        "Fn::GetAtt": [
                            "MyProviderframeworkonTimeoutD9D96588",
                            "Arn"
                        ]
                    },
                    "\"}}}"
                ]
            ]
        }
    });
});
test('fails if "queryInterval" and/or "totalTimeout" are set without "isCompleteHandler"', () => {
    // GIVEN
    const stack = new core_1.Stack();
    const handler = new lambda.Function(stack, 'MyHandler', {
        code: lambda.Code.fromAsset(path.join(__dirname, './integration-test-fixtures/s3-file-handler')),
        handler: 'index.onEvent',
        runtime: lambda.Runtime.NODEJS_10_X
    });
    // THEN
    expect(() => new cr.Provider(stack, 'provider1', {
        onEventHandler: handler,
        queryInterval: core_1.Duration.seconds(10)
    })).toThrow(/\"queryInterval\" and \"totalTimeout\" can only be configured if \"isCompleteHandler\" is specified. Otherwise, they have no meaning/);
    expect(() => new cr.Provider(stack, 'provider2', {
        onEventHandler: handler,
        totalTimeout: core_1.Duration.seconds(100)
    })).toThrow(/\"queryInterval\" and \"totalTimeout\" can only be configured if \"isCompleteHandler\" is specified. Otherwise, they have no meaning/);
});
describe('retry policy', () => {
    it('default is 30 minutes timeout in 5 second intervals', () => {
        const policy = util.calculateRetryPolicy();
        expect(policy.backoffRate).toStrictEqual(1);
        expect(policy.interval && policy.interval.toSeconds()).toStrictEqual(5);
        expect(policy.maxAttempts).toStrictEqual(360);
    });
    it('if total timeout and query interval are the same we will have one attempt', () => {
        const policy = util.calculateRetryPolicy({
            totalTimeout: core_1.Duration.minutes(5),
            queryInterval: core_1.Duration.minutes(5)
        });
        expect(policy.maxAttempts).toStrictEqual(1);
    });
    it('fails if total timeout cannot be integrally divided', () => {
        expect(() => util.calculateRetryPolicy({
            totalTimeout: core_1.Duration.seconds(100),
            queryInterval: core_1.Duration.seconds(75)
        })).toThrow(/Cannot determine retry count since totalTimeout=100s is not integrally dividable by queryInterval=75s/);
    });
    it('fails if interval > timeout', () => {
        expect(() => util.calculateRetryPolicy({
            totalTimeout: core_1.Duration.seconds(5),
            queryInterval: core_1.Duration.seconds(10)
        })).toThrow(/Cannot determine retry count since totalTimeout=5s is not integrally dividable by queryInterval=10s/);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXIudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInByb3ZpZGVyLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4Q0FBOEM7QUFDOUMsd0NBQWdEO0FBQ2hELDZCQUE2QjtBQUM3QixnQ0FBZ0M7QUFDaEMsMERBQTBEO0FBRTFELGdDQUE4QjtBQUU5QixJQUFJLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUN6QixRQUFRO0lBQ1IsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztJQUUxQixPQUFPO0lBQ1AsSUFBSSxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxZQUFZLEVBQUU7UUFDbkMsY0FBYyxFQUFFLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFO1lBQ3RELElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSw2Q0FBNkMsQ0FBQyxDQUFDO1lBQ2hHLE9BQU8sRUFBRSxlQUFlO1lBQ3hCLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7U0FDcEMsQ0FBQztLQUNILENBQUMsQ0FBQztJQUVILE9BQU87SUFFUCw4QkFBOEI7SUFDOUIsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLGNBQWMsQ0FBQyx1QkFBdUIsRUFBRTtRQUNwRCxPQUFPLEVBQUUsbUJBQW1CO1FBQzVCLFdBQVcsRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLDBCQUEwQixFQUFFLEVBQUUsWUFBWSxFQUFFLENBQUUsbUJBQW1CLEVBQUUsS0FBSyxDQUFFLEVBQUUsRUFBRSxFQUFFO1FBQzVHLE9BQU8sRUFBRSxHQUFHO0tBQ2IsQ0FBQyxDQUFDO0lBRUgseUJBQXlCO0lBQ3pCLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxjQUFjLENBQUMsdUJBQXVCLEVBQUU7UUFDcEQsT0FBTyxFQUFFLGVB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b3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnQGF3cy1jZGsvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEdXJhdGlvbiwgU3RhY2sgfSBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGNyIGZyb20gJy4uLy4uL2xpYic7XG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gJy4uLy4uL2xpYi9wcm92aWRlci1mcmFtZXdvcmsvdXRpbCc7XG5cbmltcG9ydCAnQGF3cy1jZGsvYXNzZXJ0L2plc3QnO1xuXG50ZXN0KCdtaW5pbWFsIHNldHVwJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gIC8vIFdIRU5cbiAgbmV3IGNyLlByb3ZpZGVyKHN0YWNrLCAnTXlQcm92aWRlcicsIHtcbiAgICBvbkV2ZW50SGFuZGxlcjogbmV3IGxhbWJkYS5GdW5jdGlvbihzdGFjaywgJ015SGFuZGxlcicsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi9pbnRlZ3JhdGlvbi10ZXN0LWZpeHR1cmVzL3MzLWZpbGUtaGFuZGxlcicpKSxcbiAgICAgIGhhbmRsZXI6ICdpbmRleC5vbkV2ZW50JyxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMF9YXG4gICAgfSksXG4gIH0pO1xuXG4gIC8vIFRIRU5cblxuICAvLyBmcmFtZXdvcmsgXCJvbkV2ZW50XCIgaGFuZGxlclxuICBleHBlY3Qoc3RhY2spLnRvSGF2ZVJlc291cmNlKCdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLCB7XG4gICAgSGFuZGxlcjogXCJmcmFtZXdvcmsub25FdmVudFwiLFxuICAgIEVudmlyb25tZW50OiB7IFZhcmlhYmxlczogeyBVU0VSX09OX0VWRU5UX0ZVTkNUSU9OX0FSTjogeyBcIkZuOjpHZXRBdHRcIjogWyBcIk15SGFuZGxlcjZCNzREMzEyXCIsIFwiQXJuXCIgXSB9IH0gfSxcbiAgICBUaW1lb3V0OiA5MDBcbiAgfSk7XG5cbiAgLy8gdXNlciBcIm9uRXZlbnRcIiBoYW5kbGVyXG4gIGV4cGVjdChzdGFjaykudG9IYXZlUmVzb3VyY2UoJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsIHtcbiAgICBIYW5kbGVyOiBcImluZGV4Lm9uRXZlbnRcIixcbiAgfSk7XG5cbiAgLy8gbm8gZnJhbWV3b3JrIFwiaXMgY29tcGxldGVcIiBoYW5kbGVyIG9yIHN0YXRlIG1hY2hpbmVcbiAgZXhwZWN0KHN0YWNrKS5ub3QudG9IYXZlUmVzb3VyY2UoJ0FXUzo6U3RlcEZ1bmN0aW9uczo6U3RhdGVNYWNoaW5lJyk7XG4gIGV4cGVjdChzdGFjaykubm90LnRvSGF2ZVJlc291cmNlKCdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLCB7XG4gICAgSGFuZGxlcjogXCJmcmFtZXdvcmsuaXNDb21wbGV0ZVwiLFxuICAgIFRpbWVvdXQ6IDkwMFxuICB9KTtcbn0pO1xuXG50ZXN0KCdpZiBpc0NvbXBsZXRlIGlzIHNwZWNpZmllZCwgdGhlIGlzQ29tcGxldGUgZnJhbWV3b3JrIGhhbmRsZXIgaXMgYWxzbyBpbmNsdWRlZCcsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgaGFuZGxlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdNeUhhbmRsZXInLCB7XG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICcuL2ludGVncmF0aW9uLXRlc3QtZml4dHVyZXMvczMtZmlsZS1oYW5kbGVyJykpLFxuICAgIGhhbmRsZXI6ICdpbmRleC5vbkV2ZW50JyxcbiAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTBfWFxuICB9KTtcblxuICAvLyBXSEVOXG4gIG5ldyBjci5Qcm92aWRlcihzdGFjaywgJ015UHJvdmlkZXInLCB7XG4gICAgb25FdmVudEhhbmRsZXI6IGhhbmRsZXIsXG4gICAgaXNDb21wbGV0ZUhhbmRsZXI6IGhhbmRsZXJcbiAgfSk7XG5cbiAgLy8gVEhFTlxuXG4gIC8vIGZyYW1ld29yayBcIm9uRXZlbnRcIiBoYW5kbGVyXG4gIGNvbnN0IGV4cGVjdGVkRW52ID0ge1xuICAgIFZhcmlhYmxlczoge1xuICAgICAgVVNFUl9PTl9FVkVOVF9GVU5DVElPTl9BUk46IHsgXCJGbjo6R2V0QXR0XCI6IFtcIk15SGFuZGxlcjZCNzREMzEyXCIsIFwiQXJuXCIgXSB9LFxuICAgICAgVVNFUl9JU19DT01QTEVURV9GVU5DVElPTl9BUk46IHsgXCJGbjo6R2V0QXR0XCI6IFsgXCJNeUhhbmRsZXI2Qjc0RDMxMlwiLCBcIkFyblwiIF0gfVxuICAgIH1cbiAgfTtcblxuICBleHBlY3Qoc3RhY2spLnRvSGF2ZVJlc291cmNlKCdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLCB7XG4gICAgSGFuZGxlcjogXCJmcmFtZXdvcmsub25FdmVudFwiLFxuICAgIFRpbWVvdXQ6IDkwMCxcbiAgICBFbnZpcm9ubWVudDoge1xuICAgICAgVmFyaWFibGVzOiB7XG4gICAgICAgIC4uLmV4cGVjdGVkRW52LlZhcmlhYmxlcyxcbiAgICAgICAgV0FJVEVSX1NUQVRFX01BQ0hJTkVfQVJOOiB7IFJlZjogXCJNeVByb3ZpZGVyd2FpdGVyc3RhdGVtYWNoaW5lQzFGQkI5RjlcIiB9XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICBleHBlY3Qoc3RhY2spLnRvSGF2ZVJlc291cmNlKCdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLCB7XG4gICAgSGFuZGxlcjogXCJmcmFtZXdvcmsuaXNDb21wbGV0ZVwiLFxuICAgIFRpbWVvdXQ6IDkwMCxcbiAgICBFbnZpcm9ubWVudDogZXhwZWN0ZWRFbnZcbiAgfSk7XG5cbiAgZXhwZWN0KHN0YWNrKS50b0hhdmVSZXNvdXJjZSgnQVdTOjpMYW1iZGE6OkZ1bmN0aW9uJywge1xuICAgIEhhbmRsZXI6ICdmcmFtZXdvcmsub25UaW1lb3V0JyxcbiAgICBUaW1lb3V0OiA5MDAsXG4gICAgRW52aXJvbm1lbnQ6IGV4cGVjdGVkRW52XG4gIH0pO1xuXG4gIGV4cGVjdChzdGFjaykudG9IYXZlUmVzb3VyY2UoJ0FXUzo6U3RlcEZ1bmN0aW9uczo6U3RhdGVNYWNoaW5lJywge1xuICAgIERlZmluaXRpb25TdHJpbmc6IHtcbiAgICAgIFwiRm46OkpvaW5cIjogW1xuICAgICAgICBcIlwiLFxuICAgICAgICBbXG4gICAgICAgICAgXCJ7XFxcIlN0YXJ0QXRcXFwiOlxcXCJmcmFtZXdvcmstaXNDb21wbGV0ZS10YXNrXFxcIixcXFwiU3RhdGVzXFxcIjp7XFxcImZyYW1ld29yay1pc0NvbXBsZXRlLXRhc2tcXFwiOntcXFwiRW5kXFxcIjp0cnVlLFxcXCJSZXRyeVxcXCI6W3tcXFwiRXJyb3JFcXVhbHNcXFwiOltcXFwiU3RhdGVzLkFMTFxcXCJdLFxcXCJJbnRlcnZhbFNlY29uZHNcXFwiOjUsXFxcIk1heEF0dGVtcHRzXFxcIjozNjAsXFxcIkJhY2tvZmZSYXRlXFxcIjoxfV0sXFxcIkNhdGNoXFxcIjpbe1xcXCJFcnJvckVxdWFsc1xcXCI6W1xcXCJTdGF0ZXMuQUxMXFxcIl0sXFxcIk5leHRcXFwiOlxcXCJmcmFtZXdvcmstb25UaW1lb3V0LXRhc2tcXFwifV0sXFxcIlR5cGVcXFwiOlxcXCJUYXNrXFxcIixcXFwiUmVzb3VyY2VcXFwiOlxcXCJcIixcbiAgICAgICAgICB7XG4gICAgICAgICAgICBcIkZuOjpHZXRBdHRcIjogW1xuICAgICAgICAgICAgICBcIk15UHJvdmlkZXJmcmFtZXdvcmtpc0NvbXBsZXRlMzY0MTkwRTJcIixcbiAgICAgICAgICAgICAgXCJBcm5cIlxuICAgICAgICAgICAgXVxuICAgICAgICAgIH0sXG4gICAgICAgICAgXCJcXFwifSxcXFwiZnJhbWV3b3JrLW9uVGltZW91dC10YXNrXFxcIjp7XFxcIkVuZFxcXCI6dHJ1ZSxcXFwiVHlwZVxcXCI6XFxcIlRhc2tcXFwiLFxcXCJSZXNvdXJjZVxcXCI6XFxcIlwiLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIFwiRm46OkdldEF0dFwiOiBbXG4gICAgICAgICAgICAgIFwiTXlQcm92aWRlcmZyYW1ld29ya29uVGltZW91dEQ5RDk2NTg4XCIsXG4gICAgICAgICAgICAgIFwiQXJuXCJcbiAgICAgICAgICAgIF1cbiAgICAgICAgICB9LFxuICAgICAgICAgIFwiXFxcIn19fVwiXG4gICAgICAgIF1cbiAgICAgIF1cbiAgICB9XG4gIH0pO1xufSk7XG5cbnRlc3QoJ2ZhaWxzIGlmIFwicXVlcnlJbnRlcnZhbFwiIGFuZC9vciBcInRvdGFsVGltZW91dFwiIGFyZSBzZXQgd2l0aG91dCBcImlzQ29tcGxldGVIYW5kbGVyXCInLCAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gIGNvbnN0IGhhbmRsZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCAnTXlIYW5kbGVyJywge1xuICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi9pbnRlZ3JhdGlvbi10ZXN0LWZpeHR1cmVzL3MzLWZpbGUtaGFuZGxlcicpKSxcbiAgICBoYW5kbGVyOiAnaW5kZXgub25FdmVudCcsXG4gICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzEwX1hcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QoKCkgPT4gbmV3IGNyLlByb3ZpZGVyKHN0YWNrLCAncHJvdmlkZXIxJywge1xuICAgIG9uRXZlbnRIYW5kbGVyOiBoYW5kbGVyLFxuICAgIHF1ZXJ5SW50ZXJ2YWw6IER1cmF0aW9uLnNlY29uZHMoMTApXG4gIH0pKS50b1Rocm93KC9cXFwicXVlcnlJbnRlcnZhbFxcXCIgYW5kIFxcXCJ0b3RhbFRpbWVvdXRcXFwiIGNhbiBvbmx5IGJlIGNvbmZpZ3VyZWQgaWYgXFxcImlzQ29tcGxldGVIYW5kbGVyXFxcIiBpcyBzcGVjaWZpZWQuIE90aGVyd2lzZSwgdGhleSBoYXZlIG5vIG1lYW5pbmcvKTtcblxuICBleHBlY3QoKCkgPT4gbmV3IGNyLlByb3ZpZGVyKHN0YWNrLCAncHJvdmlkZXIyJywge1xuICAgIG9uRXZlbnRIYW5kbGVyOiBoYW5kbGVyLFxuICAgIHRvdGFsVGltZW91dDogRHVyYXRpb24uc2Vjb25kcygxMDApXG4gIH0pKS50b1Rocm93KC9cXFwicXVlcnlJbnRlcnZhbFxcXCIgYW5kIFxcXCJ0b3RhbFRpbWVvdXRcXFwiIGNhbiBvbmx5IGJlIGNvbmZpZ3VyZWQgaWYgXFxcImlzQ29tcGxldGVIYW5kbGVyXFxcIiBpcyBzcGVjaWZpZWQuIE90aGVyd2lzZSwgdGhleSBoYXZlIG5vIG1lYW5pbmcvKTtcbn0pO1xuXG5kZXNjcmliZSgncmV0cnkgcG9saWN5JywgKCkgPT4ge1xuICBpdCgnZGVmYXVsdCBpcyAzMCBtaW51dGVzIHRpbWVvdXQgaW4gNSBzZWNvbmQgaW50ZXJ2YWxzJywgKCkgPT4ge1xuICAgIGNvbnN0IHBvbGljeSA9IHV0aWwuY2FsY3VsYXRlUmV0cnlQb2xpY3koKTtcbiAgICBleHBlY3QocG9saWN5LmJhY2tvZmZSYXRlKS50b1N0cmljdEVxdWFsKDEpO1xuICAgIGV4cGVjdChwb2xpY3kuaW50ZXJ2YWwgJiYgcG9saWN5LmludGVydmFsLnRvU2Vjb25kcygpKS50b1N0cmljdEVxdWFsKDUpO1xuICAgIGV4cGVjdChwb2xpY3kubWF4QXR0ZW1wdHMpLnRvU3RyaWN0RXF1YWwoMzYwKTtcbiAgfSk7XG5cbiAgaXQoJ2lmIHRvdGFsIHRpbWVvdXQgYW5kIHF1ZXJ5IGludGVydmFsIGFyZSB0aGUgc2FtZSB3ZSB3aWxsIGhhdmUgb25lIGF0dGVtcHQnLCAoKSA9PiB7XG4gICAgY29uc3QgcG9saWN5ID0gdXRpbC5jYWxjdWxhdGVSZXRyeVBvbGljeSh7XG4gICAgICB0b3RhbFRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgICBxdWVyeUludGVydmFsOiBEdXJhdGlvbi5taW51dGVzKDUpXG4gICAgfSk7XG4gICAgZXhwZWN0KHBvbGljeS5tYXhBdHRlbXB0cykudG9TdHJpY3RFcXVhbCgxKTtcbiAgfSk7XG5cbiAgaXQoJ2ZhaWxzIGlmIHRvdGFsIHRpbWVvdXQgY2Fubm90IGJlIGludGVncmFsbHkgZGl2aWRlZCcsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT4gdXRpbC5jYWxjdWxhdGVSZXRyeVBvbGljeSh7XG4gICAgICB0b3RhbFRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMoMTAwKSxcbiAgICAgIHF1ZXJ5SW50ZXJ2YWw6IER1cmF0aW9uLnNlY29uZHMoNzUpXG4gICAgfSkpLnRvVGhyb3coL0Nhbm5vdCBkZXRlcm1pbmUgcmV0cnkgY291bnQgc2luY2UgdG90YWxUaW1lb3V0PTEwMHMgaXMgbm90IGludGVncmFsbHkgZGl2aWRhYmxlIGJ5IHF1ZXJ5SW50ZXJ2YWw9NzVzLyk7XG4gIH0pO1xuXG4gIGl0KCdmYWlscyBpZiBpbnRlcnZhbCA+IHRpbWVvdXQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KCgpID0+IHV0aWwuY2FsY3VsYXRlUmV0cnlQb2xpY3koe1xuICAgICAgdG90YWxUaW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKDUpLFxuICAgICAgcXVlcnlJbnRlcnZhbDogRHVyYXRpb24uc2Vjb25kcygxMClcbiAgICB9KSkudG9UaHJvdygvQ2Fubm90IGRldGVybWluZSByZXRyeSBjb3VudCBzaW5jZSB0b3RhbFRpbWVvdXQ9NXMgaXMgbm90IGludGVncmFsbHkgZGl2aWRhYmxlIGJ5IHF1ZXJ5SW50ZXJ2YWw9MTBzLyk7XG4gIH0pO1xufSk7XG4iXX0=