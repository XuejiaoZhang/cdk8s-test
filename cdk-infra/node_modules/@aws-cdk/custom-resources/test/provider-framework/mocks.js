"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const url_1 = require("url");
const consts = require("../../lib/provider-framework/runtime/consts");
exports.MOCK_REQUEST = {
    ResponseURL: "http://pre-signed-S3-url-for-response/path/in/bucket",
    LogicalResourceId: 'MyTestResource',
    RequestId: "uniqueid-for-this-create-request",
    StackId: 'arn:aws:cloudformation:us-west-2:123456789012:stack/stack-name/guid',
};
exports.MOCK_ON_EVENT_FUNCTION_ARN = 'arn:lambda:user:on:event';
exports.MOCK_IS_COMPLETE_FUNCTION_ARN = 'arn:lambda:user:is:complete';
exports.MOCK_SFN_ARN = 'arn:of:state:machine';
exports.stringifyPayload = true;
function setup() {
    process.env[consts.WAITER_STATE_MACHINE_ARN_ENV] = exports.MOCK_SFN_ARN;
    exports.stringifyPayload = true;
    exports.onEventImplMock = undefined;
    exports.isCompleteImplMock = undefined;
    exports.cfnResponse = {};
    exports.startStateMachineInput = undefined;
}
exports.setup = setup;
async function httpRequestMock(options, body) {
    const responseUrl = url_1.parse(exports.MOCK_REQUEST.ResponseURL);
    expect(options.method).toEqual('PUT');
    expect(options.path).toEqual(responseUrl.path);
    expect(options.hostname).toEqual(responseUrl.hostname);
    const headers = options.headers || {};
    expect(headers['content-length']).toEqual(body.length);
    expect(headers['content-type']).toStrictEqual("");
    exports.cfnResponse = JSON.parse(body);
    if (!exports.cfnResponse) {
        throw new Error('unexpected');
    }
    // we always expect a physical resource id
    expect(exports.cfnResponse.PhysicalResourceId).toBeTruthy();
    // we always expect a reason
    expect(exports.cfnResponse.Reason).toBeTruthy();
    expect(exports.cfnResponse.LogicalResourceId).toEqual(exports.MOCK_REQUEST.LogicalResourceId);
    expect(exports.cfnResponse.RequestId).toEqual(exports.MOCK_REQUEST.RequestId);
    expect(exports.cfnResponse.StackId).toEqual(exports.MOCK_REQUEST.StackId);
    expect(exports.cfnResponse.Status === 'FAILED' || exports.cfnResponse.Status === 'SUCCESS').toBeTruthy();
}
exports.httpRequestMock = httpRequestMock;
async function invokeFunctionMock(req) {
    if (!req.Payload || typeof (req.Payload) !== 'string') {
        throw new Error(`invalid payload of type ${typeof (req.Payload)}}`);
    }
    const input = JSON.parse(req.Payload);
    try {
        let ret;
        switch (req.FunctionName) {
            case exports.MOCK_ON_EVENT_FUNCTION_ARN:
                if (!exports.onEventImplMock) {
                    throw new Error(`Trying to trigger "onEvent" but it is not implemented`);
                }
                ret = await exports.onEventImplMock(input);
                break;
            case exports.MOCK_IS_COMPLETE_FUNCTION_ARN:
                if (!exports.isCompleteImplMock) {
                    throw new Error(`Trying to trigger "isComplete" but it is not implemented`);
                }
                ret = await exports.isCompleteImplMock(input);
                break;
            default:
                throw new Error(`unknown mock function`);
        }
        return {
            Payload: exports.stringifyPayload ? JSON.stringify(ret) : ret
        };
    }
    catch (e) {
        return {
            FunctionError: 'Unhandled',
            Payload: JSON.stringify({
                errorType: e.name,
                errorMessage: e.message,
                trace: [
                    "AccessDenied: Access Denied",
                    "    at Request.extractError (/var/runtime/node_modules/aws-sdk/lib/services/s3.js:585:35)",
                    "    at Request.callListeners (/var/runtime/node_modules/aws-sdk/lib/sequential_executor.js:106:20)",
                    "    at Request.emit (/var/runtime/node_modules/aws-sdk/lib/sequential_executor.js:78:10)",
                    "    at Request.emit (/var/runtime/node_modules/aws-sdk/lib/request.js:683:14)",
                    "    at Request.transition (/var/runtime/node_modules/aws-sdk/lib/request.js:22:10)",
                    "    at AcceptorStateMachine.runTo (/var/runtime/node_modules/aws-sdk/lib/state_machine.js:14:12)",
                    "    at /var/runtime/node_modules/aws-sdk/lib/state_machine.js:26:10",
                    "    at Request.<anonymous> (/var/runtime/node_modules/aws-sdk/lib/request.js:38:9)",
                    "    at Request.<anonymous> (/var/runtime/node_modules/aws-sdk/lib/request.js:685:12)",
                    "    at Request.callListeners (/var/runtime/node_modules/aws-sdk/lib/sequential_executor.js:116:18)"
                ]
            })
        };
    }
}
exports.invokeFunctionMock = invokeFunctionMock;
function prepareForExecution() {
    exports.startStateMachineInput = undefined;
    if (exports.onEventImplMock) {
        process.env[consts.USER_ON_EVENT_FUNCTION_ARN_ENV] = exports.MOCK_ON_EVENT_FUNCTION_ARN;
    }
    else {
        delete process.env[consts.USER_ON_EVENT_FUNCTION_ARN_ENV];
    }
    if (exports.isCompleteImplMock) {
        process.env[consts.USER_IS_COMPLETE_FUNCTION_ARN_ENV] = exports.MOCK_IS_COMPLETE_FUNCTION_ARN;
    }
    else {
        delete process.env[consts.USER_IS_COMPLETE_FUNCTION_ARN_ENV];
    }
}
exports.prepareForExecution = prepareForExecution;
async function startExecutionMock(req) {
    exports.startStateMachineInput = req;
    expect(req.stateMachineArn).toEqual(exports.MOCK_SFN_ARN);
    return {
        executionArn: req.stateMachineArn + '/execution',
        startDate: new Date(),
    };
}
exports.startExecutionMock = startExecutionMock;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9ja3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtb2Nrcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUF3QztBQUN4QyxzRUFBc0U7QUFFekQsUUFBQSxZQUFZLEdBQUc7SUFDMUIsV0FBVyxFQUFFLHNEQUFzRDtJQUNuRSxpQkFBaUIsRUFBRSxnQkFBZ0I7SUFDbkMsU0FBUyxFQUFFLGtDQUFrQztJQUM3QyxPQUFPLEVBQUUscUVBQXFFO0NBQy9FLENBQUM7QUFFVyxRQUFBLDBCQUEwQixHQUFHLDBCQUEwQixDQUFDO0FBQ3hELFFBQUEsNkJBQTZCLEdBQUcsNkJBQTZCLENBQUM7QUFDOUQsUUFBQSxZQUFZLEdBQUcsc0JBQXNCLENBQUM7QUFFeEMsUUFBQSxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7QUFNbkMsU0FBZ0IsS0FBSztJQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyw0QkFBNEIsQ0FBQyxHQUFHLG9CQUFZLENBQUM7SUFFaEUsd0JBQWdCLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLHVCQUFlLEdBQUcsU0FBUyxDQUFDO0lBQzVCLDBCQUFrQixHQUFHLFNBQVMsQ0FBQztJQUMvQixtQkFBVyxHQUFHLEVBQVMsQ0FBQztJQUN4Qiw4QkFBc0IsR0FBRyxTQUFTLENBQUM7QUFDckMsQ0FBQztBQVJELHNCQVFDO0FBRU0sS0FBSyxVQUFVLGVBQWUsQ0FBQyxPQUE2QixFQUFFLElBQVk7SUFDL0UsTUFBTSxXQUFXLEdBQUcsV0FBUSxDQUFDLG9CQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7SUFFdkQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENB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ImltcG9ydCAqIGFzIGh0dHBzIGZyb20gJ2h0dHBzJztcbmltcG9ydCB7IHBhcnNlIGFzIHVybHBhcnNlIH0gZnJvbSAndXJsJztcbmltcG9ydCAqIGFzIGNvbnN0cyBmcm9tICcuLi8uLi9saWIvcHJvdmlkZXItZnJhbWV3b3JrL3J1bnRpbWUvY29uc3RzJztcblxuZXhwb3J0IGNvbnN0IE1PQ0tfUkVRVUVTVCA9IHtcbiAgUmVzcG9uc2VVUkw6IFwiaHR0cDovL3ByZS1zaWduZWQtUzMtdXJsLWZvci1yZXNwb25zZS9wYXRoL2luL2J1Y2tldFwiLFxuICBMb2dpY2FsUmVzb3VyY2VJZDogJ015VGVzdFJlc291cmNlJyxcbiAgUmVxdWVzdElkOiBcInVuaXF1ZWlkLWZvci10aGlzLWNyZWF0ZS1yZXF1ZXN0XCIsXG4gIFN0YWNrSWQ6ICdhcm46YXdzOmNsb3VkZm9ybWF0aW9uOnVzLXdlc3QtMjoxMjM0NTY3ODkwMTI6c3RhY2svc3RhY2stbmFtZS9ndWlkJyxcbn07XG5cbmV4cG9ydCBjb25zdCBNT0NLX09OX0VWRU5UX0ZVTkNUSU9OX0FSTiA9ICdhcm46bGFtYmRhOnVzZXI6b246ZXZlbnQnO1xuZXhwb3J0IGNvbnN0IE1PQ0tfSVNfQ09NUExFVEVfRlVOQ1RJT05fQVJOID0gJ2FybjpsYW1iZGE6dXNlcjppczpjb21wbGV0ZSc7XG5leHBvcnQgY29uc3QgTU9DS19TRk5fQVJOID0gJ2FybjpvZjpzdGF0ZTptYWNoaW5lJztcblxuZXhwb3J0IGxldCBzdHJpbmdpZnlQYXlsb2FkID0gdHJ1ZTtcbmV4cG9ydCBsZXQgb25FdmVudEltcGxNb2NrOiBBV1NDREtBc3luY0N1c3RvbVJlc291cmNlLk9uRXZlbnRIYW5kbGVyIHwgdW5kZWZpbmVkO1xuZXhwb3J0IGxldCBpc0NvbXBsZXRlSW1wbE1vY2s6IEFXU0NES0FzeW5jQ3VzdG9tUmVzb3VyY2UuSXNDb21wbGV0ZUhhbmRsZXIgfCB1bmRlZmluZWQ7XG5leHBvcnQgbGV0IHN0YXJ0U3RhdGVNYWNoaW5lSW5wdXQ6IEFXUy5TdGVwRnVuY3Rpb25zLlN0YXJ0RXhlY3V0aW9uSW5wdXQgfCB1bmRlZmluZWQ7XG5leHBvcnQgbGV0IGNmblJlc3BvbnNlOiBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVJlc3BvbnNlO1xuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXAoKSB7XG4gIHByb2Nlc3MuZW52W2NvbnN0cy5XQUlURVJfU1RBVEVfTUFDSElORV9BUk5fRU5WXSA9IE1PQ0tfU0ZOX0FSTjtcblxuICBzdHJpbmdpZnlQYXlsb2FkID0gdHJ1ZTtcbiAgb25FdmVudEltcGxNb2NrID0gdW5kZWZpbmVkO1xuICBpc0NvbXBsZXRlSW1wbE1vY2sgPSB1bmRlZmluZWQ7XG4gIGNmblJlc3BvbnNlID0ge30gYXMgYW55O1xuICBzdGFydFN0YXRlTWFjaGluZUlucHV0ID0gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaHR0cFJlcXVlc3RNb2NrKG9wdGlvbnM6IGh0dHBzLlJlcXVlc3RPcHRpb25zLCBib2R5OiBzdHJpbmcpIHtcbiAgY29uc3QgcmVzcG9uc2VVcmwgPSB1cmxwYXJzZShNT0NLX1JFUVVFU1QuUmVzcG9uc2VVUkwpO1xuXG4gIGV4cGVjdChvcHRpb25zLm1ldGhvZCkudG9FcXVhbCgnUFVUJyk7XG4gIGV4cGVjdChvcHRpb25zLnBhdGgpLnRvRXF1YWwocmVzcG9uc2VVcmwucGF0aCk7XG4gIGV4cGVjdChvcHRpb25zLmhvc3RuYW1lKS50b0VxdWFsKHJlc3BvbnNlVXJsLmhvc3RuYW1lKTtcbiAgY29uc3QgaGVhZGVycyA9IG9wdGlvbnMuaGVhZGVycyB8fCB7fTtcbiAgZXhwZWN0KGhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ10pLnRvRXF1YWwoYm9keS5sZW5ndGgpO1xuICBleHBlY3QoaGVhZGVyc1snY29udGVudC10eXBlJ10pLnRvU3RyaWN0RXF1YWwoXCJcIik7XG4gIGNmblJlc3BvbnNlID0gSlNPTi5wYXJzZShib2R5KTtcblxuICBpZiAoIWNmblJlc3BvbnNlKSB7IHRocm93IG5ldyBFcnJvcigndW5leHBlY3RlZCcpOyB9XG5cbiAgLy8gd2UgYWx3YXlzIGV4cGVjdCBhIHBoeXNpY2FsIHJlc291cmNlIGlkXG4gIGV4cGVjdChjZm5SZXNwb25zZS5QaHlzaWNhbFJlc291cmNlSWQpLnRvQmVUcnV0aHkoKTtcblxuICAvLyB3ZSBhbHdheXMgZXhwZWN0IGEgcmVhc29uXG4gIGV4cGVjdChjZm5SZXNwb25zZS5SZWFzb24pLnRvQmVUcnV0aHkoKTtcblxuICBleHBlY3QoY2ZuUmVzcG9uc2UuTG9naWNhbFJlc291cmNlSWQpLnRvRXF1YWwoTU9DS19SRVFVRVNULkxvZ2ljYWxSZXNvdXJjZUlkKTtcbiAgZXhwZWN0KGNmblJlc3BvbnNlLlJlcXVlc3RJZCkudG9FcXVhbChNT0NLX1JFUVVFU1QuUmVxdWVzdElkKTtcbiAgZXhwZWN0KGNmblJlc3BvbnNlLlN0YWNrSWQpLnRvRXF1YWwoTU9DS19SRVFVRVNULlN0YWNrSWQpO1xuICBleHBlY3QoY2ZuUmVzcG9uc2UuU3RhdHVzID09PSAnRkFJTEVEJyB8fCBjZm5SZXNwb25zZS5TdGF0dXMgPT09ICdTVUNDRVNTJykudG9CZVRydXRoeSgpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW52b2tlRnVuY3Rpb25Nb2NrKHJlcTogQVdTLkxhbWJkYS5JbnZvY2F0aW9uUmVxdWVzdCk6IFByb21pc2U8QVdTLkxhbWJkYS5JbnZvY2F0aW9uUmVzcG9uc2U+IHtcbiAgaWYgKCFyZXEuUGF5bG9hZCB8fCB0eXBlb2YgKHJlcS5QYXlsb2FkKSAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgcGF5bG9hZCBvZiB0eXBlICR7dHlwZW9mIChyZXEuUGF5bG9hZCl9fWApO1xuICB9XG5cbiAgY29uc3QgaW5wdXQgPSBKU09OLnBhcnNlKHJlcS5QYXlsb2FkKTtcblxuICB0cnkge1xuXG4gICAgbGV0IHJldDtcbiAgICBzd2l0Y2ggKHJlcS5GdW5jdGlvbk5hbWUpIHtcbiAgICAgIGNhc2UgTU9DS19PTl9FVkVOVF9GVU5DVElPTl9BUk46XG4gICAgICAgIGlmICghb25FdmVudEltcGxNb2NrKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcnlpbmcgdG8gdHJpZ2dlciBcIm9uRXZlbnRcIiBidXQgaXQgaXMgbm90IGltcGxlbWVudGVkYCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0ID0gYXdhaXQgb25FdmVudEltcGxNb2NrKGlucHV0IGFzIEFXU0NES0FzeW5jQ3VzdG9tUmVzb3VyY2UuT25FdmVudFJlcXVlc3QpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBNT0NLX0lTX0NPTVBMRVRFX0ZVTkNUSU9OX0FSTjpcbiAgICAgICAgICBpZiAoIWlzQ29tcGxldGVJbXBsTW9jaykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcnlpbmcgdG8gdHJpZ2dlciBcImlzQ29tcGxldGVcIiBidXQgaXQgaXMgbm90IGltcGxlbWVudGVkYCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldCA9IGF3YWl0IGlzQ29tcGxldGVJbXBsTW9jayhpbnB1dCBhcyBBV1NDREtBc3luY0N1c3RvbVJlc291cmNlLklzQ29tcGxldGVSZXF1ZXN0KTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIG1vY2sgZnVuY3Rpb25gKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgUGF5bG9hZDogc3RyaW5naWZ5UGF5bG9hZCA/IEpTT04uc3RyaW5naWZ5KHJldCkgOiByZXRcbiAgICB9O1xuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIEZ1bmN0aW9uRXJyb3I6ICdVbmhhbmRsZWQnLFxuICAgICAgUGF5bG9hZDogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBlcnJvclR5cGU6IGUubmFtZSxcbiAgICAgICAgZXJyb3JNZXNzYWdlOiBlLm1lc3NhZ2UsXG4gICAgICAgIHRyYWNlOiBbXG4gICAgICAgICAgXCJBY2Nlc3NEZW5pZWQ6IEFjY2VzcyBEZW5pZWRcIixcbiAgICAgICAgICBcIiAgICBhdCBSZXF1ZXN0LmV4dHJhY3RFcnJvciAoL3Zhci9ydW50aW1lL25vZGVfbW9kdWxlcy9hd3Mtc2RrL2xpYi9zZXJ2aWNlcy9zMy5qczo1ODU6MzUpXCIsXG4gICAgICAgICAgXCIgICAgYXQgUmVxdWVzdC5jYWxsTGlzdGVuZXJzICgvdmFyL3J1bnRpbWUvbm9kZV9tb2R1bGVzL2F3cy1zZGsvbGliL3NlcXVlbnRpYWxfZXhlY3V0b3IuanM6MTA2OjIwKVwiLFxuICAgICAgICAgIFwiICAgIGF0IFJlcXVlc3QuZW1pdCAoL3Zhci9ydW50aW1lL25vZGVfbW9kdWxlcy9hd3Mtc2RrL2xpYi9zZXF1ZW50aWFsX2V4ZWN1dG9yLmpzOjc4OjEwKVwiLFxuICAgICAgICAgIFwiICAgIGF0IFJlcXVlc3QuZW1pdCAoL3Zhci9ydW50aW1lL25vZGVfbW9kdWxlcy9hd3Mtc2RrL2xpYi9yZXF1ZXN0LmpzOjY4MzoxNClcIixcbiAgICAgICAgICBcIiAgICBhdCBSZXF1ZXN0LnRyYW5zaXRpb24gKC92YXIvcnVudGltZS9ub2RlX21vZHVsZXMvYXdzLXNkay9saWIvcmVxdWVzdC5qczoyMjoxMClcIixcbiAgICAgICAgICBcIiAgICBhdCBBY2NlcHRvclN0YXRlTWFjaGluZS5ydW5UbyAoL3Zhci9ydW50aW1lL25vZGVfbW9kdWxlcy9hd3Mtc2RrL2xpYi9zdGF0ZV9tYWNoaW5lLmpzOjE0OjEyKVwiLFxuICAgICAgICAgIFwiICAgIGF0IC92YXIvcnVudGltZS9ub2RlX21vZHVsZXMvYXdzLXNkay9saWIvc3RhdGVfbWFjaGluZS5qczoyNjoxMFwiLFxuICAgICAgICAgIFwiICAgIGF0IFJlcXVlc3QuPGFub255bW91cz4gKC92YXIvcnVudGltZS9ub2RlX21vZHVsZXMvYXdzLXNkay9saWIvcmVxdWVzdC5qczozODo5KVwiLFxuICAgICAgICAgIFwiICAgIGF0IFJlcXVlc3QuPGFub255bW91cz4gKC92YXIvcnVudGltZS9ub2RlX21vZHVsZXMvYXdzLXNkay9saWIvcmVxdWVzdC5qczo2ODU6MTIpXCIsXG4gICAgICAgICAgXCIgICAgYXQgUmVxdWVzdC5jYWxsTGlzdGVuZXJzICgvdmFyL3J1bnRpbWUvbm9kZV9tb2R1bGVzL2F3cy1zZGsvbGliL3NlcXVlbnRpYWxfZXhlY3V0b3IuanM6MTE2OjE4KVwiXG4gICAgICAgIF1cbiAgICAgIH0pXG4gICAgfTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJlcGFyZUZvckV4ZWN1dGlvbigpIHtcbiAgc3RhcnRTdGF0ZU1hY2hpbmVJbnB1dCA9IHVuZGVmaW5lZDtcblxuICBpZiAob25FdmVudEltcGxNb2NrKSB7XG4gICAgcHJvY2Vzcy5lbnZbY29uc3RzLlVTRVJfT05fRVZFTlRfRlVOQ1RJT05fQVJOX0VOVl0gPSBNT0NLX09OX0VWRU5UX0ZVTkNUSU9OX0FSTjtcbiAgfSBlbHNlIHtcbiAgICBkZWxldGUgcHJvY2Vzcy5lbnZbY29uc3RzLlVTRVJfT05fRVZFTlRfRlVOQ1RJT05fQVJOX0VOVl07XG4gIH1cblxuICBpZiAoaXNDb21wbGV0ZUltcGxNb2NrKSB7XG4gICAgcHJvY2Vzcy5lbnZbY29uc3RzLlVTRVJfSVNfQ09NUExFVEVfRlVOQ1RJT05fQVJOX0VOVl0gPSBNT0NLX0lTX0NPTVBMRVRFX0ZVTkNUSU9OX0FSTjtcbiAgfSBlbHNlIHtcbiAgICBkZWxldGUgcHJvY2Vzcy5lbnZbY29uc3RzLlVTRVJfSVNfQ09NUExFVEVfRlVOQ1RJT05fQVJOX0VOVl07XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0RXhlY3V0aW9uTW9jayhyZXE6IEFXUy5TdGVwRnVuY3Rpb25zLlN0YXJ0RXhlY3V0aW9uSW5wdXQpIHtcbiAgc3RhcnRTdGF0ZU1hY2hpbmVJbnB1dCA9IHJlcTtcbiAgZXhwZWN0KHJlcS5zdGF0ZU1hY2hpbmVBcm4pLnRvRXF1YWwoTU9DS19TRk5fQVJOKTtcbiAgcmV0dXJuIHtcbiAgICBleGVjdXRpb25Bcm46IHJlcS5zdGF0ZU1hY2hpbmVBcm4gKyAnL2V4ZWN1dGlvbicsXG4gICAgc3RhcnREYXRlOiBuZXcgRGF0ZSgpLFxuICB9O1xufVxuIl19