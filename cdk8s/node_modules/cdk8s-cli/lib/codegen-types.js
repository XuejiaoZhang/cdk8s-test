"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class TypeGenerator {
    constructor(schema = {}) {
        this.schema = schema;
        this.emitLater = {};
        this.emitted = new Set();
    }
    addType(typeName, def) {
        if (this.emitted.has(typeName)) {
            return;
        }
        this.emitLater[typeName] = code => {
            this.emitDescription(code, def.description);
            if (def.oneOf) {
                this.emitUnion(code, typeName, def);
                return;
            }
            if (def.properties) {
                this.emitStruct(code, typeName, def);
                return;
            }
            code.line(`export type ${typeName} = ${this.typeForProperty(def)};`);
        };
    }
    generate(code) {
        while (Object.keys(this.emitLater).length) {
            const name = Object.keys(this.emitLater)[0];
            const later = this.emitLater[name];
            later(code);
            code.line();
            delete this.emitLater[name];
            this.emitted.add(name);
        }
    }
    emitUnion(code, typeName, def) {
        code.openBlock(`export class ${typeName}`);
        for (const option of def.oneOf || []) {
            switch (option.type) {
                case 'string':
                case 'number':
                case 'boolean':
                case 'integer':
                    const type = option.type === 'integer' ? 'number' : option.type;
                    const methodName = 'from' + type[0].toUpperCase() + type.substr(1);
                    code.openBlock(`public static ${methodName}(value: ${type}): ${typeName}`);
                    code.line(`return new ${typeName}(value);`);
                    code.closeBlock();
                    break;
                default:
                    throw new Error(`unexpected union type ${option.type}`);
            }
        }
        code.openBlock(`private constructor(value: any)`);
        code.line(`Object.defineProperty(this, 'resolve', { value: () => value });`);
        code.closeBlock();
        code.closeBlock();
    }
    emitStruct(code, typeName, def) {
        const self = this;
        code.openBlock(`export interface ${typeName}`);
        for (const [propName, propSpec] of Object.entries(def.properties || {})) {
            emitProperty(propName, propSpec);
        }
        code.closeBlock();
        function emitProperty(name, def) {
            self.emitDescription(code, def.description);
            const propertyType = self.typeForProperty(def);
            const required = (Array.isArray(def.required) && def.required.includes(name));
            const optional = required ? '' : '?';
            code.line(`readonly ${name}${optional}: ${propertyType};`);
            code.line();
        }
    }
    emitDescription(code, description) {
        if (!description) {
            return;
        }
        description = description.replace(/\*\//g, '_/');
        const extractDefault = /Defaults?\W+(to|is)\W+(.+)/g.exec(description);
        const def = extractDefault && extractDefault[2];
        code.line('/**');
        code.line(` * ${description}`);
        if (def) {
            code.line(` * @default ${def}`);
        }
        code.line(' */');
    }
    typeForProperty(def) {
        if (def.oneOf) {
            throw new Error(`oneOf`);
        }
        if (def.anyOf) {
            throw new Error(`anyOf`);
        }
        if (def.properties) {
            throw new Error(`unexpected definition ${JSON.stringify(def)}`);
        }
        if (def.$ref) {
            return this.typeForRef(def);
        }
        if (def.type === 'string' && def.format === 'date-time') {
            return `Date`;
        }
        switch (def.type) {
            case undefined: return 'string';
            case 'string': return 'string';
            case 'number': return 'number';
            case 'integer': return 'number';
            case 'boolean': return 'boolean';
            case 'array': return `${this.typeForArray(def)}[]`;
            case 'object': return this.typeForObject(def);
            default:
                throw new Error(`unsupported type ${def.type}`);
        }
    }
    typeForObject(def) {
        if (def.type !== 'object') {
            throw new Error(`unexpected`);
        }
        if (!def.properties && def.additionalProperties && typeof (def.additionalProperties) === 'object') {
            return `{ [key: string]: ${this.typeForProperty(def.additionalProperties)} }`;
        }
        return `"unknown ${def}"`;
    }
    typeForRef(def) {
        if (!def.$ref) {
            throw new Error(`invalid $ref`);
        }
        const comps = def.$ref.split('.');
        const typeName = comps[comps.length - 1];
        const schema = this.resolveReference(def);
        this.addType(typeName, schema);
        return typeName;
    }
    typeForArray(def) {
        if (!def.items || typeof (def.items) !== 'object') {
            throw new Error(`unsupported array type ${def.items}`);
        }
        return this.typeForProperty(def.items);
    }
    resolveReference(def) {
        const ref = def.$ref;
        const localPrefix = '#/definitions/';
        if (!ref || !ref.startsWith(localPrefix)) {
            throw new Error(`expecting a local reference`);
        }
        if (!this.schema.definitions) {
            throw new Error(`schema does not have "definitions"`);
        }
        const lookup = ref.substr(localPrefix.length);
        const found = this.schema.definitions[lookup];
        if (!found) {
            throw new Error(`cannot resolve local reference ${ref}`);
        }
        return found;
    }
}
exports.TypeGenerator = TypeGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWdlbi10eXBlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvZGVnZW4tdHlwZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFHQSxNQUFhLGFBQWE7SUFJeEIsWUFBNkIsU0FBc0IsRUFBRztRQUF6QixXQUFNLEdBQU4sTUFBTSxDQUFtQjtRQUhyQyxjQUFTLEdBQWtELEVBQUcsQ0FBQztRQUMvRCxZQUFPLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztJQUk3QyxDQUFDO0lBRU0sT0FBTyxDQUFDLFFBQWdCLEVBQUUsR0FBZ0I7UUFDL0MsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUM5QixPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFO1lBQ2hDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUU1QyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUU7Z0JBQ2IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUNwQyxPQUFPO2FBQ1I7WUFFRCxJQUFJLEdBQUcsQ0FBQyxVQUFVLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFDckMsT0FBTzthQUNSO1lBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLFFBQVEsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2RSxDQUFDLENBQUM7SUFDSixDQUFDO0lBRU0sUUFBUSxDQUFDLElBQWU7UUFDN0IsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLEVBQUU7WUFDekMsTUFBTSxJQUFJ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QUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtZQUM1QixNQUFNLElBQUksS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7U0FDdkQ7UUFFRCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5QyxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1YsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsR0FBRyxFQUFFLENBQUMsQ0FBQztTQUMxRDtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGO0FBcE1ELHNDQW9NQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpTT05TY2hlbWE0IH0gZnJvbSBcImpzb24tc2NoZW1hXCI7XG5pbXBvcnQgeyBDb2RlTWFrZXIgfSBmcm9tIFwiY29kZW1ha2VyXCI7XG5cbmV4cG9ydCBjbGFzcyBUeXBlR2VuZXJhdG9yIHtcbiAgcHJpdmF0ZSByZWFkb25seSBlbWl0TGF0ZXI6IHsgW25hbWU6IHN0cmluZ106IChjb2RlOiBDb2RlTWFrZXIpID0+IHZvaWQgfSA9IHsgfTtcbiAgcHJpdmF0ZSByZWFkb25seSBlbWl0dGVkID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBzY2hlbWE6IEpTT05TY2hlbWE0ID0geyB9KSB7XG4gIFxuICB9XG5cbiAgcHVibGljIGFkZFR5cGUodHlwZU5hbWU6IHN0cmluZywgZGVmOiBKU09OU2NoZW1hNCkge1xuICAgIGlmICh0aGlzLmVtaXR0ZWQuaGFzKHR5cGVOYW1lKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuZW1pdExhdGVyW3R5cGVOYW1lXSA9IGNvZGUgPT4ge1xuICAgICAgdGhpcy5lbWl0RGVzY3JpcHRpb24oY29kZSwgZGVmLmRlc2NyaXB0aW9uKTtcbiAgXG4gICAgICBpZiAoZGVmLm9uZU9mKSB7XG4gICAgICAgIHRoaXMuZW1pdFVuaW9uKGNvZGUsIHR5cGVOYW1lLCBkZWYpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgXG4gICAgICBpZiAoZGVmLnByb3BlcnRpZXMpIHtcbiAgICAgICAgdGhpcy5lbWl0U3RydWN0KGNvZGUsIHR5cGVOYW1lLCBkZWYpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgXG4gICAgICBjb2RlLmxpbmUoYGV4cG9ydCB0eXBlICR7dHlwZU5hbWV9ID0gJHt0aGlzLnR5cGVGb3JQcm9wZXJ0eShkZWYpfTtgKTsgIFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgZ2VuZXJhdGUoY29kZTogQ29kZU1ha2VyKSB7XG4gICAgd2hpbGUgKE9iamVjdC5rZXlzKHRoaXMuZW1pdExhdGVyKS5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBPYmplY3Qua2V5cyh0aGlzLmVtaXRMYXRlcilbMF07XG4gICAgICBjb25zdCBsYXRlciA9IHRoaXMuZW1pdExhdGVyW25hbWVdO1xuICAgICAgbGF0ZXIoY29kZSk7XG4gICAgICBjb2RlLmxpbmUoKTtcbiAgICAgIGRlbGV0ZSB0aGlzLmVtaXRMYXRlcltuYW1lXTtcbiAgICAgIHRoaXMuZW1pdHRlZC5hZGQobmFtZSk7XG4gICAgfSAgICBcbiAgfVxuXG4gIHByaXZhdGUgZW1pdFVuaW9uKGNvZGU6IENvZGVNYWtlciwgdHlwZU5hbWU6IHN0cmluZywgZGVmOiBKU09OU2NoZW1hNCkge1xuICAgIGNvZGUub3BlbkJsb2NrKGBleHBvcnQgY2xhc3MgJHt0eXBlTmFtZX1gKTtcblxuICAgIGZvciAoY29uc3Qgb3B0aW9uIG9mIGRlZi5vbmVPZiB8fCBbXSkge1xuICAgICAgc3dpdGNoIChvcHRpb24udHlwZSkge1xuICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICBjYXNlICdudW1iZXInOlxuICAgICAgICBjYXNlICdib29sZWFuJzpcbiAgICAgICAgY2FzZSAnaW50ZWdlcic6XG4gICAgICAgICAgY29uc3QgdHlwZSA9IG9wdGlvbi50eXBlID09PSAnaW50ZWdlcicgPyAnbnVtYmVyJyA6IG9wdGlvbi50eXBlO1xuICAgICAgICAgIGNvbnN0IG1ldGhvZE5hbWUgPSAnZnJvbScgKyB0eXBlWzBdLnRvVXBwZXJDYXNlKCkgKyB0eXBlLnN1YnN0cigxKTtcbiAgICAgICAgICBjb2RlLm9wZW5CbG9jayhgcHVibGljIHN0YXRpYyAke21ldGhvZE5hbWV9KHZhbHVlOiAke3R5cGV9KTogJHt0eXBlTmFtZX1gKTtcbiAgICAgICAgICBjb2RlLmxpbmUoYHJldHVybiBuZXcgJHt0eXBlTmFtZX0odmFsdWUpO2ApO1xuICAgICAgICAgIGNvZGUuY2xvc2VCbG9jaygpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIFxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5leHBlY3RlZCB1bmlvbiB0eXBlICR7b3B0aW9uLnR5cGV9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29kZS5vcGVuQmxvY2soYHByaXZhdGUgY29uc3RydWN0b3IodmFsdWU6IGFueSlgKTtcbiAgICBjb2RlLmxpbmUoYE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAncmVzb2x2ZScsIHsgdmFsdWU6ICgpID0+IHZhbHVlIH0pO2ApO1xuICAgIGNvZGUuY2xvc2VCbG9jaygpO1xuXG4gICAgY29kZS5jbG9zZUJsb2NrKCk7XG4gIH1cblxuXG4gIHByaXZhdGUgZW1pdFN0cnVjdChjb2RlOiBDb2RlTWFrZXIsIHR5cGVOYW1lOiBzdHJpbmcsIGRlZjogSlNPTlNjaGVtYTQpIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgIGNvZGUub3BlbkJsb2NrKGBleHBvcnQgaW50ZXJmYWNlICR7dHlwZU5hbWV9YCk7XG5cbiAgICBmb3IgKGNvbnN0IFsgcHJvcE5hbWUsIHByb3BTcGVjIF0gb2YgT2JqZWN0LmVudHJpZXMoZGVmLnByb3BlcnRpZXMgfHwge30pKSB7XG4gICAgICBlbWl0UHJvcGVydHkocHJvcE5hbWUsIHByb3BTcGVjKTtcbiAgICB9XG4gIFxuICAgIGNvZGUuY2xvc2VCbG9jaygpO1xuXG4gICAgZnVuY3Rpb24gZW1pdFByb3BlcnR5KG5hbWU6IHN0cmluZywgZGVmOiBKU09OU2NoZW1hNCkge1xuICAgICAgc2VsZi5lbWl0RGVzY3JpcHRpb24oY29kZSwgZGVmLmRlc2NyaXB0aW9uKTtcbiAgICAgIGNvbnN0IHByb3BlcnR5VHlwZSA9IHNlbGYudHlwZUZvclByb3BlcnR5KGRlZik7XG4gICAgICBjb25zdCByZXF1aXJlZCA9IChBcnJheS5pc0FycmF5KGRlZi5yZXF1aXJlZCkgJiYgZGVmLnJlcXVpcmVkLmluY2x1ZGVzKG5hbWUpKTtcbiAgICAgIGNvbnN0IG9wdGlvbmFsID0gcmVxdWlyZWQgPyAnJyA6ICc/JztcbiAgXG4gICAgICBjb2RlLmxpbmUoYHJlYWRvbmx5ICR7bmFtZX0ke29wdGlvbmFsfTogJHtwcm9wZXJ0eVR5cGV9O2ApO1xuICAgICAgY29kZS5saW5lKCk7XG4gICAgfSAgXG4gIH1cblxuICBwcml2YXRlIGVtaXREZXNjcmlwdGlvbihjb2RlOiBDb2RlTWFrZXIsIGRlc2NyaXB0aW9uPzogc3RyaW5nKSB7XG4gICAgaWYgKCFkZXNjcmlwdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgXG4gICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbi5yZXBsYWNlKC9cXCpcXC8vZywgJ18vJyk7XG5cbiAgICBjb25zdCBleHRyYWN0RGVmYXVsdCA9IC9EZWZhdWx0cz9cXFcrKHRvfGlzKVxcVysoLispL2cuZXhlYyhkZXNjcmlwdGlvbik7XG4gICAgY29uc3QgZGVmID0gZXh0cmFjdERlZmF1bHQgJiYgZXh0cmFjdERlZmF1bHRbMl07XG4gIFxuICAgIGNvZGUubGluZSgnLyoqJyk7XG4gICAgY29kZS5saW5lKGAgKiAke2Rlc2NyaXB0aW9ufWApO1xuICAgIGlmIChkZWYpIHtcbiAgICAgIGNvZGUubGluZShgICogQGRlZmF1bHQgJHtkZWZ9YCkgICAgXG4gICAgfVxuICAgIGNvZGUubGluZSgnICovJylcbiAgfVxuXG4gIHByaXZhdGUgdHlwZUZvclByb3BlcnR5KGRlZjogSlNPTlNjaGVtYTQpOiBzdHJpbmcge1xuICAgIGlmIChkZWYub25lT2YpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgb25lT2ZgKTtcbiAgICB9XG5cbiAgICBpZiAoZGVmLmFueU9mKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGFueU9mYCk7XG4gICAgfVxuXG4gICAgaWYgKGRlZi5wcm9wZXJ0aWVzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHVuZXhwZWN0ZWQgZGVmaW5pdGlvbiAke0pTT04uc3RyaW5naWZ5KGRlZil9YCk7XG4gICAgfVxuXG4gICAgaWYgKGRlZi4kcmVmKSB7XG4gICAgICByZXR1cm4gdGhpcy50eXBlRm9yUmVmKGRlZik7XG4gICAgfVxuXG4gICAgaWYgKGRlZi50eXBlID09PSAnc3RyaW5nJyAmJiBkZWYuZm9ybWF0ID09PSAnZGF0ZS10aW1lJykge1xuICAgICAgcmV0dXJuIGBEYXRlYDtcbiAgICB9XG4gIFxuICAgIHN3aXRjaCAoZGVmLnR5cGUpIHtcbiAgICAgIGNhc2UgdW5kZWZpbmVkOiByZXR1cm4gJ3N0cmluZyc7XG4gICAgICBjYXNlICdzdHJpbmcnOiByZXR1cm4gJ3N0cmluZyc7XG4gICAgICBjYXNlICdudW1iZXInOiByZXR1cm4gJ251bWJlcic7XG4gICAgICBjYXNlICdpbnRlZ2VyJzogcmV0dXJuICdudW1iZXInO1xuICAgICAgY2FzZSAnYm9vbGVhbic6IHJldHVybiAnYm9vbGVhbic7XG4gICAgICBjYXNlICdhcnJheSc6IHJldHVybiBgJHt0aGlzLnR5cGVGb3JBcnJheShkZWYpfVtdYDtcbiAgICAgIGNhc2UgJ29iamVjdCc6IHJldHVybiB0aGlzLnR5cGVGb3JPYmplY3QoZGVmKTtcbiAgICAgICAgXG4gICAgICBkZWZhdWx0OiBcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bnN1cHBvcnRlZCB0eXBlICR7ZGVmLnR5cGV9YCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0eXBlRm9yT2JqZWN0KGRlZjogSlNPTlNjaGVtYTQpOiBzdHJpbmcge1xuICAgIGlmIChkZWYudHlwZSAhPT0gJ29iamVjdCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgdW5leHBlY3RlZGApO1xuICAgIH1cblxuICAgIGlmICghZGVmLnByb3BlcnRpZXMgJiYgZGVmLmFkZGl0aW9uYWxQcm9wZXJ0aWVzICYmIHR5cGVvZihkZWYuYWRkaXRpb25hbFByb3BlcnRpZXMpID09PSAnb2JqZWN0Jykge1xuICAgICAgcmV0dXJuIGB7IFtrZXk6IHN0cmluZ106ICR7dGhpcy50eXBlRm9yUHJvcGVydHkoZGVmLmFkZGl0aW9uYWxQcm9wZXJ0aWVzKX0gfWA7XG4gICAgfVxuXG4gICAgcmV0dXJuIGBcInVua25vd24gJHtkZWZ9XCJgO1xuICB9XG5cbiAgcHJpdmF0ZSB0eXBlRm9yUmVmKGRlZjogSlNPTlNjaGVtYTQpOiBzdHJpbmcge1xuICAgIGlmICghZGVmLiRyZWYpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCAkcmVmYCk7XG4gICAgfVxuXG4gICAgY29uc3QgY29tcHMgPSBkZWYuJHJlZi5zcGxpdCgnLicpO1xuICAgIGNvbnN0IHR5cGVOYW1lID0gY29tcHNbY29tcHMubGVuZ3RoIC0gMV07XG4gICAgY29uc3Qgc2NoZW1hID0gdGhpcy5yZXNvbHZlUmVmZXJlbmNlKGRlZik7XG4gICAgdGhpcy5hZGRUeXBlKHR5cGVOYW1lLCBzY2hlbWEpO1xuICAgIHJldHVybiB0eXBlTmFtZTtcbiAgfVxuXG4gIHByaXZhdGUgdHlwZUZvckFycmF5KGRlZjogSlNPTlNjaGVtYTQpOiBzdHJpbmcge1xuICAgIGlmICghZGVmLml0ZW1zIHx8IHR5cGVvZihkZWYuaXRlbXMpICE9PSAnb2JqZWN0Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bnN1cHBvcnRlZCBhcnJheSB0eXBlICR7ZGVmLml0ZW1zfWApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnR5cGVGb3JQcm9wZXJ0eShkZWYuaXRlbXMpO1xuICB9ICBcblxuICBwcml2YXRlIHJlc29sdmVSZWZlcmVuY2UoZGVmOiBKU09OU2NoZW1hNCk6IEpTT05TY2hlbWE0IHtcbiAgICBjb25zdCByZWYgPSBkZWYuJHJlZjtcbiAgICBjb25zdCBsb2NhbFByZWZpeCA9ICcjL2RlZmluaXRpb25zLyc7XG4gICAgaWYgKCFyZWYgfHwgIXJlZi5zdGFydHNXaXRoKGxvY2FsUHJlZml4KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBleHBlY3RpbmcgYSBsb2NhbCByZWZlcmVuY2VgKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuc2NoZW1hLmRlZmluaXRpb25zKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHNjaGVtYSBkb2VzIG5vdCBoYXZlIFwiZGVmaW5pdGlvbnNcImApO1xuICAgIH1cblxuICAgIGNvbnN0IGxvb2t1cCA9IHJlZi5zdWJzdHIobG9jYWxQcmVmaXgubGVuZ3RoKTtcbiAgICBjb25zdCBmb3VuZCA9IHRoaXMuc2NoZW1hLmRlZmluaXRpb25zW2xvb2t1cF07XG4gICAgaWYgKCFmb3VuZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBjYW5ub3QgcmVzb2x2ZSBsb2NhbCByZWZlcmVuY2UgJHtyZWZ9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZvdW5kO1xuICB9ICBcbn1cblxuIl19