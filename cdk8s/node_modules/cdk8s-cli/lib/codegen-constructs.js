"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const codegen_types_1 = require("./codegen-types");
exports.X_GROUP_VERSION_KIND = 'x-kubernetes-group-version-kind';
/**
 * Generates a construct for an API object defined by `def`.
 */
function emitConstructForApiObject(code, schema, def) {
    var _a;
    const objectNames = def[exports.X_GROUP_VERSION_KIND];
    if (!objectNames) {
        throw new Error(`object must include a ${exports.X_GROUP_VERSION_KIND} key`);
    }
    const objectName = objectNames[0];
    if (!objectName) {
        throw new Error(`no object name`);
    }
    const groupPrefix = objectName.group ? `${objectName.group.toLocaleLowerCase().replace(/\./g, '-')}-` : '';
    const baseName = `${groupPrefix}${objectName.kind.toLocaleLowerCase()}-${objectName.version.toLocaleLowerCase()}`;
    if (!((_a = def.properties) === null || _a === void 0 ? void 0 : _a.metadata)) {
        console.error(`warning: no "metadata", skipping ${baseName}`);
        return;
    }
    const sourceFile = `${baseName}.ts`;
    const optionsStructName = `${objectName.kind}Options`;
    const typeGenerator = new codegen_types_1.TypeGenerator(schema);
    emitFile();
    function emitFile() {
        code.openFile(sourceFile);
        code.line(`// generated by cdk8s`);
        code.line();
        code.line(`import { ApiObject } from 'cdk8s';`);
        code.line(`import { Construct } from '@aws-cdk/core';`);
        code.line();
        emitOptionsStruct();
        code.line();
        emitConstruct();
        code.line();
        typeGenerator.generate(code);
        code.closeFile(sourceFile);
    }
    function emitOptionsStruct() {
        const copy = { ...def };
        copy.properties = copy.properties || {};
        delete copy.properties.apiVersion;
        delete copy.properties.kind;
        delete copy.properties.status;
        typeGenerator.addType(optionsStructName, copy);
    }
    function emitConstruct() {
        var _a;
        code.line('/**');
        code.line(` * ${(_a = def) === null || _a === void 0 ? void 0 : _a.description}`);
        code.line(` */`);
        code.openBlock(`export class ${objectName.kind} extends ApiObject`);
        emitInitializer();
        code.closeBlock();
    }
    function emitInitializer() {
        code.openBlock(`public constructor(scope: Construct, ns: string, options: ${optionsStructName})`);
        emitInitializerSuper();
        code.closeBlock();
    }
    function emitInitializerSuper() {
        const groupPrefix = objectName.group ? `${objectName.group}/` : '';
        code.open(`super(scope, ns, {`);
        code.line(`...options,`);
        code.line(`kind: '${objectName.kind}',`);
        code.line(`apiVersion: '${groupPrefix}${objectName.version}',`);
        code.close(`});`);
    }
}
exports.emitConstructForApiObject = emitConstructForApiObject;
/**
 * Returns all schema definitions for API objects (objects that have the 'x-kubernetes-group-version-kind' annotation)
 */
function findApiObjectDefinitions(schema) {
    const result = new Array();
    for (const def of Object.values(schema.definitions || {})) {
        const kinds = def[exports.X_GROUP_VERSION_KIND];
        if (!kinds) {
            continue;
        }
        result.push(def);
    }
    return result;
}
exports.findApiObjectDefinitions = findApiObjectDefinitions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWdlbi1jb25zdHJ1Y3RzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29kZWdlbi1jb25zdHJ1Y3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsbURBQWdEO0FBUW5DLFFBQUEsb0JBQW9CLEdBQUcsaUNBQWlDLENBQUM7QUFFdEU7O0dBRUc7QUFDSCxTQUFnQix5QkFBeUIsQ0FBQyxJQUFlLEVBQUUsTUFBbUIsRUFBRSxHQUFnQjs7SUFDOUYsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLDRCQUFvQixDQUF1QixDQUFDO0lBQ3BFLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsNEJBQW9CLE1BQU0sQ0FBQyxDQUFDO0tBQ3RFO0lBRUQsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLElBQUksQ0FBQyxVQUFVLEVBQUU7UUFDZixNQUFNLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7S0FDbkM7SUFFRCxNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUMzRyxNQUFNLFFBQVEsR0FBRyxHQUFHLFdBQVcsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLENBQUM7SUFFbEgsSUFBSSxRQUFDLEdBQUcsQ0FBQyxVQUFVLDBDQUFFLFFBQVEsQ0FBQSxFQUFFO1FBQzdCLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDOUQsT0FBTztLQUNSO0lBRUQsTUFBTSxVQUFVLEdBQUcsR0FBRyxR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QWUsQ0FBQztJQUN4QyxLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsSUFBSSxFQUFHLENBQUMsRUFBRTtRQUMxRCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsNEJBQW9CLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1YsU0FBUztTQUNWO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNsQjtJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFaRCw0REFZQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpTT05TY2hlbWE0IH0gZnJvbSBcImpzb24tc2NoZW1hXCI7XG5pbXBvcnQgeyBDb2RlTWFrZXIgfSBmcm9tICdjb2RlbWFrZXInO1xuaW1wb3J0IHsgVHlwZUdlbmVyYXRvciB9IGZyb20gXCIuL2NvZGVnZW4tdHlwZXNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBHcm91cFZlcnNpb25LaW5kIHtcbiAgcmVhZG9ubHkgZ3JvdXA6IHN0cmluZztcbiAgcmVhZG9ubHkga2luZDogc3RyaW5nO1xuICByZWFkb25seSB2ZXJzaW9uOiBzdHJpbmdcbn1cblxuZXhwb3J0IGNvbnN0IFhfR1JPVVBfVkVSU0lPTl9LSU5EID0gJ3gta3ViZXJuZXRlcy1ncm91cC12ZXJzaW9uLWtpbmQnO1xuXG4vKipcbiAqIEdlbmVyYXRlcyBhIGNvbnN0cnVjdCBmb3IgYW4gQVBJIG9iamVjdCBkZWZpbmVkIGJ5IGBkZWZgLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZW1pdENvbnN0cnVjdEZvckFwaU9iamVjdChjb2RlOiBDb2RlTWFrZXIsIHNjaGVtYTogSlNPTlNjaGVtYTQsIGRlZjogSlNPTlNjaGVtYTQpIHtcbiAgY29uc3Qgb2JqZWN0TmFtZXMgPSBkZWZbWF9HUk9VUF9WRVJTSU9OX0tJTkRdIGFzIEdyb3VwVmVyc2lvbktpbmRbXTtcbiAgaWYgKCFvYmplY3ROYW1lcykge1xuICAgIHRocm93IG5ldyBFcnJvcihgb2JqZWN0IG11c3QgaW5jbHVkZSBhICR7WF9HUk9VUF9WRVJTSU9OX0tJTkR9IGtleWApO1xuICB9XG5cbiAgY29uc3Qgb2JqZWN0TmFtZSA9IG9iamVjdE5hbWVzWzBdO1xuICBpZiAoIW9iamVjdE5hbWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYG5vIG9iamVjdCBuYW1lYCk7XG4gIH1cblxuICBjb25zdCBncm91cFByZWZpeCA9IG9iamVjdE5hbWUuZ3JvdXAgPyBgJHtvYmplY3ROYW1lLmdyb3VwLnRvTG9jYWxlTG93ZXJDYXNlKCkucmVwbGFjZSgvXFwuL2csICctJyl9LWAgOiAnJztcbiAgY29uc3QgYmFzZU5hbWUgPSBgJHtncm91cFByZWZpeH0ke29iamVjdE5hbWUua2luZC50b0xvY2FsZUxvd2VyQ2FzZSgpfS0ke29iamVjdE5hbWUudmVyc2lvbi50b0xvY2FsZUxvd2VyQ2FzZSgpfWA7XG5cbiAgaWYgKCFkZWYucHJvcGVydGllcz8ubWV0YWRhdGEpIHtcbiAgICBjb25zb2xlLmVycm9yKGB3YXJuaW5nOiBubyBcIm1ldGFkYXRhXCIsIHNraXBwaW5nICR7YmFzZU5hbWV9YCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qgc291cmNlRmlsZSA9IGAke2Jhc2VOYW1lfS50c2A7XG4gIGNvbnN0IG9wdGlvbnNTdHJ1Y3ROYW1lID0gYCR7b2JqZWN0TmFtZS5raW5kfU9wdGlvbnNgO1xuXG4gIGNvbnN0IHR5cGVHZW5lcmF0b3IgPSBuZXcgVHlwZUdlbmVyYXRvcihzY2hlbWEpO1xuXG4gIGVtaXRGaWxlKCk7XG5cbiAgZnVuY3Rpb24gZW1pdEZpbGUoKSB7XG4gICAgY29kZS5vcGVuRmlsZShzb3VyY2VGaWxlKTtcbiAgICBjb2RlLmxpbmUoYC8vIGdlbmVyYXRlZCBieSBjZGs4c2ApO1xuICAgIGNvZGUubGluZSgpO1xuXG4gICAgY29kZS5saW5lKGBpbXBvcnQgeyBBcGlPYmplY3QgfSBmcm9tICdjZGs4cyc7YCk7XG4gICAgY29kZS5saW5lKGBpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdAYXdzLWNkay9jb3JlJztgKTtcbiAgICBjb2RlLmxpbmUoKTtcbiAgXG4gICAgZW1pdE9wdGlvbnNTdHJ1Y3QoKTtcblxuICAgIGNvZGUubGluZSgpO1xuXG4gICAgZW1pdENvbnN0cnVjdCgpO1xuICAgIGNvZGUubGluZSgpO1xuXG4gICAgdHlwZUdlbmVyYXRvci5nZW5lcmF0ZShjb2RlKTtcbiAgXG4gICAgY29kZS5jbG9zZUZpbGUoc291cmNlRmlsZSk7XG4gIH1cblxuICBmdW5jdGlvbiBlbWl0T3B0aW9uc1N0cnVjdCgpIHtcbiAgICBjb25zdCBjb3B5OiBKU09OU2NoZW1hNCA9IHsgLi4uZGVmIH07XG4gICAgY29weS5wcm9wZXJ0aWVzID0gY29weS5wcm9wZXJ0aWVzIHx8IHt9O1xuICAgIGRlbGV0ZSBjb3B5LnByb3BlcnRpZXMhLmFwaVZlcnNpb247XG4gICAgZGVsZXRlIGNvcHkucHJvcGVydGllcyEua2luZDtcbiAgICBkZWxldGUgY29weS5wcm9wZXJ0aWVzIS5zdGF0dXM7XG5cbiAgICB0eXBlR2VuZXJhdG9yLmFkZFR5cGUob3B0aW9uc1N0cnVjdE5hbWUsIGNvcHkpO1xuICB9XG4gIFxuICBmdW5jdGlvbiBlbWl0Q29uc3RydWN0KCkge1xuICAgIGNvZGUubGluZSgnLyoqJyk7XG4gICAgY29kZS5saW5lKGAgKiAkeyBkZWY/LmRlc2NyaXB0aW9uIH1gKTtcbiAgICBjb2RlLmxpbmUoYCAqL2ApO1xuICAgIGNvZGUub3BlbkJsb2NrKGBleHBvcnQgY2xhc3MgJHtvYmplY3ROYW1lLmtpbmR9IGV4dGVuZHMgQXBpT2JqZWN0YCk7XG5cbiAgICBlbWl0SW5pdGlhbGl6ZXIoKTtcbiAgXG4gICAgY29kZS5jbG9zZUJsb2NrKCk7XG4gIH1cblxuICBmdW5jdGlvbiBlbWl0SW5pdGlhbGl6ZXIoKSB7XG4gICAgY29kZS5vcGVuQmxvY2soYHB1YmxpYyBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBuczogc3RyaW5nLCBvcHRpb25zOiAke29wdGlvbnNTdHJ1Y3ROYW1lfSlgKTtcbiAgICBlbWl0SW5pdGlhbGl6ZXJTdXBlcigpO1xuXG4gICAgY29kZS5jbG9zZUJsb2NrKCk7XG4gIH1cblxuICBmdW5jdGlvbiBlbWl0SW5pdGlhbGl6ZXJTdXBlcigpIHtcbiAgICBjb25zdCBncm91cFByZWZpeCA9IG9iamVjdE5hbWUuZ3JvdXAgPyBgJHtvYmplY3ROYW1lLmdyb3VwfS9gIDogJyc7XG4gICAgY29kZS5vcGVuKGBzdXBlcihzY29wZSwgbnMsIHtgKTtcbiAgICBjb2RlLmxpbmUoYC4uLm9wdGlvbnMsYCk7XG4gICAgY29kZS5saW5lKGBraW5kOiAnJHtvYmplY3ROYW1lLmtpbmR9JyxgKTtcbiAgICBjb2RlLmxpbmUoYGFwaVZlcnNpb246ICcke2dyb3VwUHJlZml4fSR7b2JqZWN0TmFtZS52ZXJzaW9ufScsYCk7XG4gICAgY29kZS5jbG9zZShgfSk7YCk7ICAgIFxuICB9XG59XG5cbi8qKlxuICogUmV0dXJucyBhbGwgc2NoZW1hIGRlZmluaXRpb25zIGZvciBBUEkgb2JqZWN0cyAob2JqZWN0cyB0aGF0IGhhdmUgdGhlICd4LWt1YmVybmV0ZXMtZ3JvdXAtdmVyc2lvbi1raW5kJyBhbm5vdGF0aW9uKVxuICovXG5leHBvcnQgZnVuY3Rpb24gZmluZEFwaU9iamVjdERlZmluaXRpb25zKHNjaGVtYTogSlNPTlNjaGVtYTQpIHtcbiAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5PEpTT05TY2hlbWE0PigpO1xuICBmb3IgKGNvbnN0IGRlZiBvZiBPYmplY3QudmFsdWVzKHNjaGVtYS5kZWZpbml0aW9ucyB8fCB7IH0pKSB7XG4gICAgY29uc3Qga2luZHMgPSBkZWZbWF9HUk9VUF9WRVJTSU9OX0tJTkRdO1xuICAgIGlmICgha2luZHMpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIHJlc3VsdC5wdXNoKGRlZik7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufSJdfQ==